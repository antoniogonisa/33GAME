<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>33 Razones para Amarte üíù</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Quicksand:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #BFF8F1;
            --primary-dark: #9DE5DD;
            --accent: #FFB6C1;
            --text: #2C3E50;
            --light: #FFFFFF;
            --shadow: rgba(191, 248, 241, 0.3);
            --error: #FF6B6B;
            --success: #4CAF50;
        }

        /* Toast/Notification System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }

        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
            border-left: 4px solid;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--error);
        }

        .toast.info {
            border-left-color: var(--primary);
        }

        .toast-icon {
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .toast-message {
            font-size: 0.9em;
            color: var(--text);
            flex: 1;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #BFF8F1 0%, #E8F8F5 50%, #FFE5EC 100%);
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden;
        }

        /* Portada */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #BFF8F1 0%, #E8F8F5 50%, #FFE5EC 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 1s ease;
        }

        .welcome-screen.hidden {
            animation: fadeOut 0.5s ease forwards;
            pointer-events: none;
        }

        .welcome-content {
            text-align: center;
            padding: 40px 30px;
            max-width: 500px;
        }

        .welcome-icon {
            font-size: 5em;
            margin-bottom: 30px;
            animation: float 3s ease-in-out infinite;
        }

        .welcome-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5em;
            color: var(--text);
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(255, 182, 193, 0.3);
            line-height: 1.3;
        }

        .welcome-subtitle {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 40px;
            font-weight: 300;
            line-height: 1.6;
        }

        .start-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border: none;
            padding: 20px 50px;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Quicksand', sans-serif;
            color: var(--text);
            box-shadow: 0 10px 30px var(--shadow);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--shadow);
        }

        .start-btn:active {
            transform: translateY(-2px);
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            padding: 30px 0 20px;
            animation: fadeInDown 0.8s ease;
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.2em;
            color: var(--text);
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(255, 182, 193, 0.3);
        }

        .header .subtitle {
            font-size: 1em;
            color: #666;
            font-weight: 300;
        }

        .progress-container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 8px 30px var(--shadow);
            animation: fadeIn 1s ease;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 0.95em;
        }

        .progress-bar {
            height: 12px;
            background: #E8F8F5;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 10px;
            transition: width 0.6s cubic-bezier(0.65, 0, 0.35, 1);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        .card {
            background: white;
            border-radius: 25px;
            padding: 35px 25px;
            box-shadow: 0 10px 40px var(--shadow);
            animation: slideUp 0.6s ease;
            margin-bottom: 20px;
        }

        .challenge-number {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: var(--text);
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .challenge-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.6em;
            margin-bottom: 15px;
            color: var(--text);
        }

        .challenge-description {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-btn {
            background: linear-gradient(135deg, #F8FBFF 0%, var(--primary) 100%);
            border: 2px solid var(--primary-dark);
            padding: 18px;
            border-radius: 15px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Quicksand', sans-serif;
            font-weight: 500;
            color: var(--text);
            text-align: left;
        }

        .option-btn:hover {
            transform: translateX(8px);
            box-shadow: 0 5px 20px var(--shadow);
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }

        .option-btn.correct {
            background: linear-gradient(135deg, #A8E6CF 0%, #77DD77 100%);
            border-color: #4CAF50;
            animation: correctPulse 0.5s ease;
        }

        .option-btn.incorrect {
            background: linear-gradient(135deg, #FFB6B6 0%, #FF8A8A 100%);
            border-color: #F44336;
            animation: shake 0.5s ease;
        }

        .input-field {
            width: 100%;
            padding: 18px;
            border: 2px solid var(--primary-dark);
            border-radius: 15px;
            font-size: 1em;
            font-family: 'Quicksand', sans-serif;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #F8FBFF 0%, #FFFFFF 100%);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(255, 182, 193, 0.2);
            transform: scale(1.02);
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border: none;
            padding: 18px 35px;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Quicksand', sans-serif;
            color: var(--text);
            width: 100%;
            margin-top: 15px;
            box-shadow: 0 5px 20px var(--shadow);
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px var(--shadow);
        }

        .submit-btn:active {
            transform: translateY(-1px);
        }

        /* Memory Game */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .memory-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .memory-card:hover {
            transform: scale(1.05);
        }

        .memory-card.flipped {
            background: white;
            border-color: var(--accent);
        }

        .memory-card.matched {
            background: linear-gradient(135deg, #A8E6CF, #77DD77);
            border-color: #4CAF50;
            animation: matchPulse 0.5s ease;
        }

        /* Find Hearts Game */
        .hearts-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .heart-item {
            font-size: 3em;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 10px;
            border-radius: 15px;
        }

        .heart-item:hover {
            transform: scale(1.2);
        }

        .heart-item.found {
            animation: heartBounce 0.5s ease;
            transform: scale(1.3);
        }

        .hearts-counter {
            text-align: center;
            font-size: 1.3em;
            font-weight: 600;
            color: var(--accent);
            margin-top: 15px;
        }

        /* Slider Game */
        .slider-container {
            margin: 30px 0;
        }

        .love-slider {
            width: 100%;
            height: 15px;
            border-radius: 10px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            outline: none;
            -webkit-appearance: none;
        }

        .love-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--accent);
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .slider-value {
            text-align: center;
            font-size: 2.5em;
            font-weight: 700;
            color: var(--accent);
            margin: 20px 0;
        }

        /* Reaction Game */
        .reaction-area {
            background: linear-gradient(135deg, #F8FBFF, #E8F8F5);
            border-radius: 20px;
            padding: 60px 20px;
            text-align: center;
            margin: 20px 0;
            border: 3px dashed var(--primary-dark);
        }

        /* Puzzle Game */
        .puzzle-pieces {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .puzzle-piece {
            aspect-ratio: 1;
            background: linear-gradient(135deg, var(--primary), white);
            border: 2px solid var(--primary-dark);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .puzzle-piece:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, var(--accent), white);
        }

        .puzzle-piece.correct-position {
            background: linear-gradient(135deg, #A8E6CF, #77DD77);
            border-color: #4CAF50;
        }

        /* Timeline/Chronological Game */
        .timeline-container {
            margin: 30px 0;
        }

        .timeline-item {
            background: linear-gradient(135deg, #F8FBFF 0%, var(--primary) 100%);
            border: 2px solid var(--primary-dark);
            padding: 15px 20px;
            border-radius: 15px;
            margin: 10px 0;
            cursor: move;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .timeline-item:hover {
            transform: translateX(8px);
            box-shadow: 0 5px 20px var(--shadow);
        }

        .timeline-item.dragging {
            opacity: 0.5;
        }

        .timeline-item.correct-order {
            background: linear-gradient(135deg, #A8E6CF 0%, #77DD77 100%);
            border-color: #4CAF50;
        }

        /* Draw Heart Game (Canvas) */
        .canvas-container {
            position: relative;
            margin: 20px auto;
            max-width: 300px;
        }

        #heartCanvas {
            border: 3px solid var(--primary-dark);
            border-radius: 20px;
            background: white;
            cursor: crosshair;
            width: 100%;
            height: auto;
        }

        .canvas-instruction {
            text-align: center;
            margin-top: 15px;
            color: #666;
            font-size: 0.9em;
        }

        /* Photo Match Game */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .photo-piece {
            aspect-ratio: 1;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }

        .photo-piece:hover {
            transform: scale(1.05);
            border-color: var(--accent);
        }

        .photo-piece.selected {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--shadow);
        }

        .photo-piece.matched {
            border-color: #4CAF50;
            animation: matchPulse 0.5s ease;
        }

        /* Final Screen */
        .final-screen {
            text-align: center;
            padding: 40px 20px;
            animation: fadeIn 1.5s ease;
        }

        .celebration {
            font-size: 4em;
            margin: 20px 0;
            animation: bounce 1s ease infinite;
        }

        .final-screen h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2.2em;
            color: var(--text);
            margin: 30px 0 20px;
        }

        .final-message {
            font-size: 1.2em;
            line-height: 1.8;
            color: #666;
            margin: 30px 0;
            padding: 30px;
            background: linear-gradient(135deg, #F8FBFF, #FFE5EC);
            border-radius: 20px;
            border: 2px solid var(--accent);
        }

        .reveal-container {
            margin: 40px 0;
            padding: 30px;
            background: white;
            border-radius: 25px;
            box-shadow: 0 10px 40px var(--shadow);
            animation: slideUp 1s ease 1.5s backwards;
        }

        .reveal-title {
            font-size: 1.5em;
            color: var(--accent);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .alhambra-icon {
            font-size: 5em;
            margin: 20px 0;
            animation: glow 2s ease infinite;
        }

        .dinner-details {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            padding: 25px;
            border-radius: 20px;
            margin: 20px 0;
        }

        .dinner-details h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .dinner-details p {
            font-size: 1.1em;
            margin: 10px 0;
            font-weight: 500;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes matchPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes heartBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes glow {
            0%, 100% { 
                text-shadow: 0 0 10px var(--accent),
                            0 0 20px var(--accent),
                            0 0 30px var(--accent);
            }
            50% { 
                text-shadow: 0 0 20px var(--accent),
                            0 0 30px var(--accent),
                            0 0 40px var(--accent);
            }
        }
    </style>
</head>
<body>
    <!-- Pantalla de Bienvenida -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-content">
            <div class="welcome-icon">üíù</div>
            <h1 class="welcome-title">33 Razones para Amarte</h1>
            <p class="welcome-subtitle">Un viaje por nuestra historia juntos.<br>Cada desaf√≠o es un recuerdo especial.</p>
            <button class="start-btn" onclick="startGame()">Comenzar ‚ú®</button>
        </div>
    </div>

    <!-- Toast Container para notificaciones -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container">
        <div class="header">
            <h1>33 Razones para Amarte üíù</h1>
            <p class="subtitle">Un viaje por nuestros momentos especiales</p>
        </div>

        <div class="progress-container">
            <div class="progress-info">
                <span>Progreso</span>
                <span id="progressText">0/33</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>

        <div class="card" id="challengeCard"></div>
    </div>

    <script>
        // ========================================
        // SISTEMA DE GESTI√ìN DE ERRORES
        // ========================================
        class ErrorHandler {
            static showToast(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    info: '‚ÑπÔ∏è'
                };
                
                toast.innerHTML = `
                    <span class="toast-icon">${icons[type]}</span>
                    <span class="toast-message">${message}</span>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            static validateInput(value) {
                if (!value || value.trim() === '') {
                    this.showToast('Por favor completa este campo', 'error');
                    return false;
                }
                return true;
            }

            static handleImageError(img, container) {
                img.onerror = null;
                container.classList.add('image-error');
                container.innerHTML = 'üñºÔ∏è';
                this.showToast('Algunas fotos no se pudieron cargar', 'error');
            }

            static safeLocalStorage = {
                get: function(key, defaultValue = null) {
                    try {
                        const item = localStorage.getItem(key);
                        return item ? JSON.parse(item) : defaultValue;
                    } catch (error) {
                        console.error('Error al leer de localStorage:', error);
                        return defaultValue;
                    }
                },
                set: function(key, value) {
                    try {
                        localStorage.setItem(key, JSON.stringify(value));
                        return true;
                    } catch (error) {
                        console.error('Error al guardar en localStorage:', error);
                        return false;
                    }
                },
                remove: function(key) {
                    try {
                        localStorage.removeItem(key);
                        return true;
                    } catch (error) {
                        console.error('Error al eliminar de localStorage:', error);
                        return false;
                    }
                }
            };
        }

        // ========================================
        // PORTADA Y INICIO DEL JUEGO
        // ========================================
        function startGame() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            welcomeScreen.classList.add('hidden');
            setTimeout(() => {
                welcomeScreen.remove();
            }, 500);
        }

        // ========================================
        // VARIABLES DEL JUEGO
        // ========================================
        let currentChallenge = 0;
        let memoryCards = [];
        let memoryFlipped = [];
        let memoryMatched = [];
        let heartsFound = 0;
        let reactionStartTime = 0;
        let puzzleOrder = [];
        let draggedElement = null;
        let heartPoints = [];
        let currentHeartPoint = 0;
        let photoMatches = [];
        let selectedPhotos = [];

        const challenges = [
            // DESAF√çO 1: Primer beso
            {
                type: 'multiple',
                title: '¬øQu√© d√≠a es nuestro aniversario?',
                description: 'El d√≠a que todo empez√≥... üíã',
                options: [
                    '3 de septiembre',
                    '3 de octubre',
                    '3 de noviembre',
                    '3 de diciembre'
                ],
                correct: 1
            },

            // DESAF√çO 2: PSV-Sevilla
            {
                type: 'multiple',
                title: '¬øContra qu√© equipo jugaba el Sevilla el d√≠a de nuestro primer beso?',
                description: 'Aquel partido memorable... ‚öΩ',
                options: [
                    'PSV Eindhoven',
                    'Ajax',
                    'Manchester United',
                    'Arsenal'
                ],
                correct: 0
            },

            // DESAF√çO 3: El cangrejo
            {
                type: 'multiple',
                title: '¬øQu√© estaba haciendo cuando me viste por primera vez en la piscina?',
                description: 'Seg√∫n t√∫, fue muy gracioso... üòÇ',
                options: [
                    'Jugando al voley',
                    'Haciendo el cangrejo',
                    'Tir√°ndome de bomba',
                    'Nadando estilo libre'
                ],
                correct: 1
            },

            // DESAF√çO 4: Primera cita
            {
                type: 'multiple',
                title: '¬øQu√© pel√≠cula vimos en nuestra primera cita?',
                description: 'Nada m√°s rom√°ntico que... üé¨',
                options: [
                    'El Conjuro',
                    'Terrifier',
                    'Saw X',
                    'Scream VI'
                ],
                correct: 2
            },

            // DESAF√çO 5: An√©cdota legendaria
            {
                type: 'multiple',
                title: '¬øQu√© me respondiste cuando te dije "te quiero" por primera vez viendo al Sevilla?',
                description: 'Nunca lo olvidar√©... üòÇ‚öΩ',
                options: [
                    'Control hist√≥rico de En Nesyri',
                    'Yo tambi√©n te quiero',
                    'Gol del Sevilla',
                    'Espera que est√°n atacando'
                ],
                correct: 0
            },

            // DESAF√çO 6: Primera escapada
            {
                type: 'multiple',
                title: '¬øCu√°l fue nuestro primer destino juntos?',
                description: 'Nuestra primera escapada rom√°ntica... üå≤',
                options: [
                    'Cazorla',
                    'Sierra de Grazalema',
                    'San Nicol√°s del Puerto',
                    'Aracena'
                ],
                correct: 2
            },

            // DESAF√çO 7: Granada
            {
                type: 'multiple',
                title: '¬øCu√°ntas veces habremos estado en Granada cuando leas esto?',
                description: 'Contando el d√≠a de hoy... üè∞',
                options: [
                    '1 vez',
                    '2 veces',
                    '3 veces',
                    '4 veces'
                ],
                correct: 2
            },

            // DESAF√çO 8: Cazorla
            {
                type: 'input',
                title: '¬øQu√© artista escuch√°bamos de camino a Cazorla?',
                description: 'Ese viaje de spa y relax... üéµ',
                answer: 'pablo alboran'
            },

            // DESAF√çO 9: Canci√≥n favorita
            {
                type: 'input',
                title: '¬øCu√°l es nuestra canci√≥n favorita?',
                description: 'La que siempre nos hace sonre√≠r... üåô',
                answer: 'con la luna llena'
            },

            // DESAF√çO 10: Primer viaje internacional
            {
                type: 'multiple',
                title: '¬øCu√°l fue nuestro primer viaje fuera de Espa√±a?',
                description: 'La primera aventura internacional... ‚úàÔ∏è',
                options: [
                    'Par√≠s',
                    'Roma',
                    '√Åmsterdam',
                    'Londres'
                ],
                correct: 3
            },

            // DESAF√çO 11: Memory Game - Ciudades
            {
                type: 'memory',
                title: 'Encuentra las parejas de ciudades',
                description: 'Empareja los lugares que hemos visitado juntos... üó∫Ô∏è',
                pairs: ['üé°', 'üçï', 'üè∞', 'üéª', 'üèñÔ∏è', '‚öΩ', 'üå≤', 'üé≠']
            },

            // DESAF√çO 12: Concierto cancelado
            {
                type: 'input',
                title: '¬øQu√© concierto √≠bamos a ver en Granada y nos cancelaron?',
                description: 'Vaya chasco... üé§',
                answer: 'rels'
            },

            // DESAF√çO 13: Apodos
            {
                type: 'input',
                title: '¬øC√≥mo me llamas cari√±osamente?',
                description: 'Escribe uno de nuestros apodos... üíï',
                answer: 'gordi'
            },

            // DESAF√çO 14: Juego simple de tapping
            {
                type: 'tapHearts',
                title: 'Dale a todos los corazones lo m√°s r√°pido posible',
                description: 'Toca los 12 corazones en cualquier orden... ‚ù§Ô∏è‚ö°',
                total: 12
            },

            // DESAF√çO 15: Viajes Sevilla
            {
                type: 'input',
                title: '¬øA cu√°ntos partidos del Sevilla hemos ido fuera de casa juntos?',
                description: 'Escribe el n√∫mero... ‚öΩ',
                answer: '7'
            },

            // DESAF√çO 16: Completa la canci√≥n - Con la luna llena
            {
                type: 'multiple',
                title: 'Completa la letra de "Con la luna llena"',
                description: '"Porque te quiero como el mar quiere a un pez que nada adentro, d√°ndole de respirar, protegi√©ndolo del _____"',
                options: [
                    'cielo',
                    'mundo',
                    'viento',
                    'tiempo'
                ],
                correct: 2
            },

            // DESAF√çO 17: Ordena cronol√≥gicamente
            {
                type: 'timeline',
                title: 'Ordena estos momentos del m√°s antiguo al m√°s reciente',
                description: 'Toca para reordenar... üìÖ',
                events: [
                    { text: 'ü¶Ä Cangrejo en la piscina', order: 0 },
                    { text: 'üíã Primer beso (PSV-Sevilla)', order: 1 },
                    { text: 'üå≤ San Nicol√°s del Puerto', order: 2 },
                    { text: 'üè∞ Primera vez en Granada', order: 3 },
                    { text: 'üé° Viaje a Londres', order: 4 }
                ]
            },

            // DESAF√çO 18: Slider amor
            {
                type: 'slider',
                title: '¬øCu√°nto me quieres?',
                description: 'Desliza hasta el nivel correcto... üíï',
                target: 100
            },

            // DESAF√çO 19: Pregunta simple
            {
                type: 'multiple',
                title: '¬øQu√© nos gusta hacer juntos m√°s que nada?',
                description: 'Pensando en todos nuestros momentos... üí≠',
                options: [
                    'Ver al Sevilla',
                    'Viajar',
                    'Ir a conciertos',
                    'Todo, si estamos juntos'
                ],
                correct: 3
            },

            // DESAF√çO 20: Budapest y Viena
            {
                type: 'multiple',
                title: '¬øQu√© dos ciudades visitamos en el mismo viaje?',
                description: 'Nuestro √∫ltimo gran viaje... üéªüè∞',
                options: [
                    'Budapest y Viena',
                    'Londres y Par√≠s',
                    'Mil√°n y Venecia',
                    'Praga y Berl√≠n'
                ],
                correct: 0
            },

            // DESAF√çO 21: Find Hearts 2
            {
                type: 'findHearts',
                title: 'Encuentra los 4 corazones rojos',
                description: 'Un poco m√°s dif√≠cil esta vez... ‚ù§Ô∏è',
                target: 4
            },

            // DESAF√çO 22: Match de fotos
            {
                type: 'photoMatch',
                title: 'Encuentra las parejas de nuestras fotos',
                description: 'Empareja las mitades correctas... üì∏',
                photos: [
                    // AQU√ç IR√ÅN TUS 3 FOTOS
                    // Por ahora uso placeholders, despu√©s t√∫ las reemplazas
                    'foto1.jpg',
                    'foto2.jpg',
                    'foto3.jpg'
                ]
            },

            // DESAF√çO 23: Fuerteventura
            {
                type: 'input',
                title: '¬øEn qu√© isla de Canarias estuvimos?',
                description: 'Sol, playa y relax... üèñÔ∏è',
                answer: 'fuerteventura'
            },

            // DESAF√çO 24: Mil√°n
            {
                type: 'multiple',
                title: '¬øEn qu√© mes fuimos a Mil√°n?',
                description: 'Ciudad de la moda... üçï',
                options: [
                    'Febrero 2025',
                    'Enero 2025',
                    'Marzo 2025',
                    'Abril 2025'
                ],
                correct: 0
            },

            // DESAF√çO 25: Juego de reacci√≥n
            {
                type: 'reaction',
                title: '¬°Pon a prueba tus reflejos!',
                description: 'Espera a que aparezca el coraz√≥n y t√≥calo r√°pido... ‚ö°',
                timeout: 3000
            },

            // DESAF√çO 26: Puzzle n√∫meros especiales
            {
                type: 'puzzle',
                title: 'Ordena estos n√∫meros',
                description: 'Del 1 al 9... üß©',
                numbers: [5, 2, 8, 1, 9, 3, 7, 4, 6]
            },

            // DESAF√çO 27: Santander y Oviedo
            {
                type: 'multiple',
                title: '¬øCu√°l de estas ciudades del norte NO hemos visitado juntos?',
                description: 'Conociendo Espa√±a... üá™üá∏',
                options: [
                    'Oviedo',
                    'Santander',
                    'San Sebasti√°n',
                    'Bilbao'
                ],
                correct: 2
            },

            // DESAF√çO 28: Finde Costa Ballena
            {
                type: 'multiple',
                title: '¬øD√≥nde fuimos el primer finde cuando volviste de Montana?',
                description: 'Aquel reencuentro... üåä',
                options: [
                    'Nos quedamos en casa',
                    'Costa Ballena',
                    'Fuimos de compras',
                    'Fuimos al campo'
                ],
                correct: 1
            },

            // DESAF√çO 29: Regalo primer aniversario
            {
                type: 'multiple',
                title: '¬øQu√© te regal√© en nuestro primer aniversario?',
                description: 'Aquel 3 de octubre... üéÅ',
                options: [
                    'Una canci√≥n',
                    'Un viaje',
                    'Un concierto',
                    'Todo lo anterior'
                ],
                correct: 3
            },

            // DESAF√çO 30: Nombre del perro
            {
                type: 'multiple',
                title: '¬øC√≥mo hemos dicho de llamar a nuestro futuro perro?',
                description: 'Nuestro peque√±o amigo... üêï',
                options: [
                    'Ever',
                    'Rocky',
                    'Max',
                    'Bruno'
                ],
                correct: 0
            },

            // DESAF√çO 31: Hotel caja sorpresa
            {
                type: 'multiple',
                title: '¬øD√≥nde nos toc√≥ el hotel en la caja sorpresa que me regalaste?',
                description: 'Aquella escapada... üéÅüè®',
                options: [
                    'Setenil de las Bodegas',
                    'La L√≠nea de la Concepci√≥n',
                    'Ronda',
                    'Algeciras'
                ],
                correct: 1
            },

            // DESAF√çO 32: Verano en Montana
            {
                type: 'input',
                title: '¬øD√≥nde te fuiste el primer verano que est√°bamos juntos?',
                description: 'Aquel viaje largo... ‚úàÔ∏è',
                answer: 'montana'
            },

            // DESAF√çO 33: Pregunta especial (antes era 32)
            {
                type: 'multiple',
                title: '¬øQu√© hace especial cada momento contigo?',
                description: 'La respuesta m√°s importante... üíù',
                options: [
                    'La aventura',
                    'La diversi√≥n',
                    'Que estamos juntos',
                    'Todo lo anterior'
                ],
                correct: 3
            },

            // DESAF√çO 34: FINAL
            {
                type: 'final',
                title: '¬°Lo has conseguido! üéâ',
                message: `33 razones... pero hay una m√°s especial:

T√∫ me regalaste Granada, y hoy quiero devolverte ese momento m√°gico.

Desde aquel "Control hist√≥rico de En Nesyri" hasta hoy, cada momento contigo ha sido especial. Desde el cangrejo en la piscina hasta nuestros viajes por el mundo, desde Saw X hasta bailar "Con la luna llena".`,
                surprise: {
                    title: 'Esta noche...',
                    location: 'Cenaremos viendo la Alhambra iluminada üè∞',
                    detail: 'Restaurante Las Tomasas a las 21:00',
                    message: 'Porque despu√©s de completar este desaf√≠o, mereces el mejor premio: una noche inolvidable juntos üí´'
                }
            }
        ];

        function updateProgress() {
            const totalChallenges = 33; // Total de desaf√≠os (sin contar la pantalla final)
            const currentProgress = Math.min(currentChallenge, totalChallenges);
            const percentage = (currentProgress / totalChallenges) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${currentProgress}/${totalChallenges}`;
        }

        function renderChallenge() {
            const challenge = challenges[currentChallenge];
            const card = document.getElementById('challengeCard');
            let html = '';

            if (challenge.type !== 'final') {
                html += `<div class="challenge-number">Desaf√≠o ${currentChallenge + 1}/33</div>`;
            }

            switch (challenge.type) {
                case 'multiple':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="options">
                            ${challenge.options.map((option, index) => 
                                `<button class="option-btn" onclick="checkMultiple(${index})">${option}</button>`
                            ).join('')}
                        </div>
                    `;
                    break;

                case 'input':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <input type="text" class="input-field" id="answerInput" placeholder="Escribe tu respuesta...">
                        <button class="submit-btn" onclick="checkInput()">Comprobar</button>
                    `;
                    break;

                case 'memory':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="memory-grid" id="memoryGrid"></div>
                    `;
                    setTimeout(() => initMemoryGame(challenge.pairs), 100);
                    break;

                case 'findHearts':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="hearts-container" id="heartsContainer"></div>
                        <div class="hearts-counter" id="heartsCounter">0/${challenge.target}</div>
                    `;
                    setTimeout(() => initFindHearts(challenge.target), 100);
                    break;

                case 'tapHearts':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="hearts-container" id="heartsContainer"></div>
                        <div class="hearts-counter" id="heartsCounter">0/${challenge.total}</div>
                    `;
                    setTimeout(() => initTapHearts(challenge.total), 100);
                    break;

                case 'slider':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="slider-container">
                            <div class="slider-value" id="sliderValue">50</div>
                            <input type="range" min="0" max="100" value="50" class="love-slider" id="loveSlider" 
                                   oninput="document.getElementById('sliderValue').textContent = this.value">
                        </div>
                        <button class="submit-btn" onclick="checkSlider(${challenge.target})">Confirmar</button>
                    `;
                    break;

                case 'reaction':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="reaction-area" id="reactionArea">
                            <p style="font-size: 1.2em; color: #666;">Prep√°rate...</p>
                        </div>
                    `;
                    setTimeout(() => initReactionGame(challenge.timeout), 100);
                    break;

                case 'puzzle':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="puzzle-pieces" id="puzzleGrid"></div>
                        <button class="submit-btn" onclick="checkPuzzle()">Verificar Orden</button>
                    `;
                    setTimeout(() => initPuzzle(challenge.numbers), 100);
                    break;

                case 'timeline':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="timeline-container" id="timelineContainer"></div>
                        <button class="submit-btn" onclick="checkTimeline()">Verificar Orden</button>
                    `;
                    setTimeout(() => initTimeline(challenge.events), 100);
                    break;

                case 'drawHeart':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="canvas-container">
                            <canvas id="heartCanvas" width="300" height="300"></canvas>
                            <p class="canvas-instruction">Punto actual: <span id="currentPoint">1</span>/${challenge.points}</p>
                        </div>
                    `;
                    setTimeout(() => initDrawHeart(challenge.points), 100);
                    break;

                case 'photoMatch':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="photo-grid" id="photoGrid"></div>
                    `;
                    setTimeout(() => initPhotoMatch(challenge.photos), 100);
                    break;

                case 'sequence':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div id="sequenceDisplay" style="text-align: center; font-size: 4em; min-height: 100px; margin: 30px 0;"></div>
                        <div class="hearts-container" id="sequenceButtons" style="display: none;"></div>
                    `;
                    setTimeout(() => initSequenceGame(challenge.length), 100);
                    break;

                case 'final':
                    html = `
                        <div class="final-screen">
                            <div class="celebration">üéâüíùüéä</div>
                            <h2>${challenge.title}</h2>
                            <div class="final-message">${challenge.message}</div>
                            
                            <div class="reveal-container">
                                <div class="reveal-title">‚ú® Pero espera... hay algo m√°s ‚ú®</div>
                                <div class="alhambra-icon">üè∞</div>
                                <div class="dinner-details">
                                    <h3>${challenge.surprise.location}</h3>
                                    <p>${challenge.surprise.detail}</p>
                                    <p style="margin-top: 20px; font-size: 1.3em;">‚è∞ Esta noche nos espera algo especial</p>
                                </div>
                                <div class="final-message" style="margin-top: 30px;">
                                    ${challenge.surprise.message}
                                </div>
                            </div>
                            
                            <div class="celebration">‚ù§Ô∏èüíïüíñ</div>
                        </div>
                    `;
                    break;
            }

            card.innerHTML = html;
            updateProgress();
        }

        function checkMultiple(selected) {
            const challenge = challenges[currentChallenge];
            const buttons = document.querySelectorAll('.option-btn');
            
            // Prevenir m√∫ltiples clics
            buttons.forEach(btn => btn.disabled = true);
            
            if (selected === challenge.correct) {
                buttons[selected].classList.add('correct');
                ErrorHandler.showToast('¬°Correcto! üéâ', 'success');
                setTimeout(() => nextChallenge(), 1000);
            } else {
                buttons[selected].classList.add('incorrect');
                ErrorHandler.showToast('¬°Casi! Int√©ntalo de nuevo', 'error');
                setTimeout(() => {
                    buttons[selected].classList.remove('incorrect');
                    buttons.forEach(btn => btn.disabled = false);
                }, 500);
            }
        }

        function checkInput() {
            const inputElement = document.getElementById('answerInput');
            const input = inputElement.value.toLowerCase().trim();
            const challenge = challenges[currentChallenge];
            
            // Validar que el input no est√© vac√≠o
            if (!ErrorHandler.validateInput(input)) {
                inputElement.style.animation = 'shake 0.5s ease';
                setTimeout(() => inputElement.style.animation = 'none', 500);
                return;
            }
            
            // Array de respuestas aceptables para ciertos desaf√≠os
            let isCorrect = false;
            
            // Desaf√≠o 13 (apodos) - aceptar m√∫ltiples variantes
            if (challenge.title && challenge.title.includes('cari√±osamente')) {
                const validAnswers = ['gordi', 'gordito', 'gordita', 'amor', 'amore', 'mi vida', 'vida'];
                isCorrect = validAnswers.some(answer => input.includes(answer));
            } 
            // Desaf√≠o 12 (conciertos cancelados) - aceptar Rels B y variantes
            else if (challenge.description && challenge.description.includes('cancelaron')) {
                isCorrect = input.includes('rels');
            }
            // Desaf√≠o 33 (Montana) - aceptar Montana, EEUU, Estados Unidos
            else if (challenge.title && challenge.title.includes('primer verano')) {
                isCorrect = input.includes('montana') || input.includes('eeuu') || 
                           input.includes('estados unidos') || input.includes('usa');
            }
            // Otros desaf√≠os
            else {
                isCorrect = input.includes(challenge.answer.toLowerCase());
            }
            
            if (isCorrect) {
                inputElement.style.borderColor = '#4CAF50';
                inputElement.style.background = 'linear-gradient(135deg, #A8E6CF, #E8F5E9)';
                inputElement.disabled = true;
                ErrorHandler.showToast('¬°Correcto! üéâ', 'success');
                setTimeout(() => nextChallenge(), 1000);
            } else {
                inputElement.style.borderColor = '#F44336';
                inputElement.style.animation = 'shake 0.5s ease';
                ErrorHandler.showToast('¬°Casi! Int√©ntalo de nuevo', 'error');
                setTimeout(() => {
                    inputElement.style.borderColor = '#9DE5DD';
                    inputElement.style.animation = 'none';
                    inputElement.value = '';
                    inputElement.focus();
                }, 500);
            }
        }

        function initMemoryGame(pairs) {
            memoryFlipped = [];
            memoryMatched = [];
            const allSymbols = [...pairs, ...pairs];
            memoryCards = allSymbols.sort(() => Math.random() - 0.5);
            
            const grid = document.getElementById('memoryGrid');
            grid.innerHTML = memoryCards.map((symbol, i) => 
                `<div class="memory-card" onclick="flipCard(${i})" data-symbol="${symbol}" data-index="${i}">
                    <span style="display: none;">${symbol}</span>
                </div>`
            ).join('');
        }

        function flipCard(index) {
            if (memoryFlipped.length >= 2 || memoryMatched.includes(index) || memoryFlipped.includes(index)) return;
            
            const cards = document.querySelectorAll('.memory-card');
            const card = cards[index];
            card.classList.add('flipped');
            card.querySelector('span').style.display = 'block';
            memoryFlipped.push(index);

            if (memoryFlipped.length === 2) {
                const [first, second] = memoryFlipped;
                const firstSymbol = cards[first].dataset.symbol;
                const secondSymbol = cards[second].dataset.symbol;

                if (firstSymbol === secondSymbol) {
                    setTimeout(() => {
                        cards[first].classList.add('matched');
                        cards[second].classList.add('matched');
                        memoryMatched.push(first, second);
                        memoryFlipped = [];

                        if (memoryMatched.length === memoryCards.length) {
                            ErrorHandler.showToast('¬°Todas las parejas encontradas! üéâ', 'success');
                            setTimeout(() => nextChallenge(), 1000);
                        }
                    }, 500);
                } else {
                    setTimeout(() => {
                        cards[first].classList.remove('flipped');
                        cards[second].classList.remove('flipped');
                        cards[first].querySelector('span').style.display = 'none';
                        cards[second].querySelector('span').style.display = 'none';
                        memoryFlipped = [];
                    }, 1000);
                }
            }
        }

        function initFindHearts(target) {
            heartsFound = 0;
            const container = document.getElementById('heartsContainer');
            const hearts = ['üíô', 'üíö', 'üíõ', 'üíú', '‚ù§Ô∏è', 'üß°', 'üíù', 'üíñ'];
            const redHeartPositions = [];
            
            while (redHeartPositions.length < target) {
                const pos = Math.floor(Math.random() * 8);
                if (!redHeartPositions.includes(pos)) {
                    redHeartPositions.push(pos);
                }
            }

            container.innerHTML = hearts.map((heart, i) => {
                const isRed = redHeartPositions.includes(i);
                return `<div class="heart-item" onclick="clickHeart(this, ${isRed}, ${target})">${isRed ? '‚ù§Ô∏è' : heart}</div>`;
            }).join('');
        }

        function clickHeart(element, isCorrect, target) {
            if (element.classList.contains('found')) return;
            
            if (isCorrect) {
                element.classList.add('found');
                heartsFound++;
                document.getElementById('heartsCounter').textContent = `${heartsFound}/${target}`;
                
                if (heartsFound === target) {
                    setTimeout(() => nextChallenge(), 1000);
                }
            }
        }

        function initTapHearts(total) {
            heartsFound = 0;
            const container = document.getElementById('heartsContainer');
            const hearts = ['‚ù§Ô∏è', 'üíï', 'üíñ', 'üíó', 'üíì', 'üíù', 'üíò', 'üíû', 'üíô', 'üíö', 'üíõ', 'üíú'];
            
            container.innerHTML = hearts.map((heart, i) => 
                `<div class="heart-item" onclick="tapHeart(this, ${total})">${heart}</div>`
            ).join('');
        }

        function tapHeart(element, total) {
            if (element.classList.contains('found')) return;
            
            element.classList.add('found');
            element.style.opacity = '0.3';
            heartsFound++;
            document.getElementById('heartsCounter').textContent = `${heartsFound}/${total}`;
            
            if (heartsFound === total) {
                setTimeout(() => nextChallenge(), 1000);
            }
        }

        function checkSlider(target) {
            const value = parseInt(document.getElementById('loveSlider').value);
            if (value === target) {
                ErrorHandler.showToast('¬°Exacto! üíï', 'success');
                nextChallenge();
            } else if (value >= target - 5) {
                ErrorHandler.showToast('Venga ya... sabes que me quieres m√°s jejejeje üíï', 'info');
            } else if (value >= target - 15) {
                ErrorHandler.showToast('¬°Casi! Un poquito m√°s... üíï', 'info');
            } else {
                ErrorHandler.showToast('¬°M√°s amor! ‚ù§Ô∏è', 'info');
            }
        }

        function initReactionGame(timeout) {
            const area = document.getElementById('reactionArea');
            const delay = Math.random() * 2000 + 1000;
            
            setTimeout(() => {
                reactionStartTime = Date.now();
                area.innerHTML = `
                    <div style="font-size: 5em; padding: 40px 0; cursor: pointer;" onclick="reactionClick()">‚ù§Ô∏è</div>
                    <p>¬°TOCA AHORA!</p>
                `;
            }, delay);
        }

        function reactionClick() {
            const reactionTime = Date.now() - reactionStartTime;
            const area = document.getElementById('reactionArea');
            area.innerHTML = `
                <div style="font-size: 3em; padding: 30px 0;">üéØ</div>
                <p>¬°Tu tiempo: ${reactionTime}ms!</p>
                <p style="margin-top: 15px;">¬°Reflejos incre√≠bles! ‚ö°</p>
            `;
            setTimeout(() => nextChallenge(), 2000);
        }

        function initPuzzle(numbers) {
            puzzleOrder = [...numbers];
            const grid = document.getElementById('puzzleGrid');
            grid.innerHTML = puzzleOrder.map((num, i) => 
                `<div class="puzzle-piece" onclick="swapPuzzle(${i})" data-index="${i}">${num}</div>`
            ).join('');
        }

        let selectedPuzzlePiece = null;

        function swapPuzzle(index) {
            if (selectedPuzzlePiece === null) {
                selectedPuzzlePiece = index;
                document.querySelectorAll('.puzzle-piece')[index].style.border = '3px solid ' + getComputedStyle(document.documentElement).getPropertyValue('--accent');
            } else {
                [puzzleOrder[selectedPuzzlePiece], puzzleOrder[index]] = [puzzleOrder[index], puzzleOrder[selectedPuzzlePiece]];
                initPuzzle(puzzleOrder);
                selectedPuzzlePiece = null;
            }
        }

        function checkPuzzle() {
            const isCorrect = puzzleOrder.every((num, i) => num === i + 1);
            if (isCorrect) {
                document.querySelectorAll('.puzzle-piece').forEach(piece => {
                    piece.classList.add('correct-position');
                });
                ErrorHandler.showToast('¬°Puzzle completado! üß©', 'success');
                setTimeout(() => nextChallenge(), 1000);
            } else {
                ErrorHandler.showToast('¬°Casi! Sigue intent√°ndolo üß©', 'error');
            }
        }

        function initTimeline(events) {
            const container = document.getElementById('timelineContainer');
            const shuffled = [...events].sort(() => Math.random() - 0.5);
            
            // Guardamos el orden correcto en cada elemento
            container.innerHTML = shuffled.map((event, i) => 
                `<div class="timeline-item" data-order="${event.order}" data-text="${event.text}">
                    ${event.text}
                </div>`
            ).join('');

            // A√±adir event listeners a cada item
            const items = container.querySelectorAll('.timeline-item');
            items.forEach(item => {
                item.addEventListener('click', function() {
                    selectTimelineItem(this);
                });
            });
        }

        let firstSelectedTimeline = null;

        function selectTimelineItem(clickedElement) {
            if (firstSelectedTimeline === null) {
                // Primer click - seleccionar
                firstSelectedTimeline = clickedElement;
                clickedElement.style.border = '3px solid ' + getComputedStyle(document.documentElement).getPropertyValue('--accent');
                clickedElement.style.transform = 'scale(1.02)';
            } else {
                if (firstSelectedTimeline === clickedElement) {
                    // Click en el mismo elemento - deseleccionar
                    clickedElement.style.border = '2px solid var(--primary-dark)';
                    clickedElement.style.transform = 'scale(1)';
                    firstSelectedTimeline = null;
                    return;
                }
                
                // Segundo click - intercambiar posiciones en el DOM
                const container = document.getElementById('timelineContainer');
                const allItems = Array.from(container.querySelectorAll('.timeline-item'));
                const firstIndex = allItems.indexOf(firstSelectedTimeline);
                const secondIndex = allItems.indexOf(clickedElement);
                
                // Guardar referencias
                const firstItem = firstSelectedTimeline;
                const secondItem = clickedElement;
                
                // Intercambiar en el DOM
                if (firstIndex < secondIndex) {
                    container.insertBefore(secondItem, firstItem);
                    container.insertBefore(firstItem, allItems[secondIndex].nextSibling);
                } else {
                    container.insertBefore(firstItem, secondItem);
                    container.insertBefore(secondItem, allItems[firstIndex].nextSibling);
                }
                
                // Resetear estilos de todos los items
                container.querySelectorAll('.timeline-item').forEach(item => {
                    item.style.border = '2px solid var(--primary-dark)';
                    item.style.transform = 'scale(1)';
                });
                
                firstSelectedTimeline = null;
            }
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            if (this !== draggedElement) {
                const allItems = [...document.querySelectorAll('.timeline-item')];
                const draggedIndex = allItems.indexOf(draggedElement);
                const targetIndex = allItems.indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedElement, this);
                }
            }
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
        }

        function checkTimeline() {
            const items = document.querySelectorAll('.timeline-item');
            let isCorrect = true;
            
            items.forEach((item, index) => {
                if (parseInt(item.dataset.order) === index) {
                    item.classList.add('correct-order');
                } else {
                    isCorrect = false;
                }
            });

            if (isCorrect) {
                ErrorHandler.showToast('¬°Orden correcto! üìÖ', 'success');
                setTimeout(() => nextChallenge(), 1500);
            } else {
                ErrorHandler.showToast('¬°Casi! Int√©ntalo de nuevo üìÖ', 'error');
                setTimeout(() => {
                    items.forEach(item => item.classList.remove('correct-order'));
                }, 1000);
            }
        }

        function initDrawHeart(numPoints) {
            const canvas = document.getElementById('heartCanvas');
            const ctx = canvas.getContext('2d');
            currentHeartPoint = 0;
            heartPoints = [];

            // Generar puntos en forma de coraz√≥n
            const centerX = 150;
            const centerY = 150;
            const size = 80;

            for (let i = 0; i < numPoints; i++) {
                const t = (i / numPoints) * Math.PI * 2;
                const x = centerX + size * (16 * Math.pow(Math.sin(t), 3));
                const y = centerY - size * (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) / 16;
                heartPoints.push({x, y, number: i + 1});
            }

            // Dibujar puntos
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            heartPoints.forEach(point => {
                ctx.beginPath();
                ctx.arc(point.x, point.y, 15, 0, Math.PI * 2);
                ctx.fillStyle = '#BFF8F1';
                ctx.fill();
                ctx.strokeStyle = '#9DE5DD';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.fillStyle = '#2C3E50';
                ctx.font = 'bold 12px Quicksand';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(point.number, point.x, point.y);
            });

            canvas.onclick = function(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;

                const nextPoint = heartPoints[currentHeartPoint];
                const distance = Math.sqrt(Math.pow(x - nextPoint.x, 2) + Math.pow(y - nextPoint.y, 2));

                if (distance < 20) {
                    ctx.beginPath();
                    ctx.arc(nextPoint.x, nextPoint.y, 15, 0, Math.PI * 2);
                    ctx.fillStyle = '#FFB6C1';
                    ctx.fill();
                    
                    if (currentHeartPoint > 0) {
                        const prevPoint = heartPoints[currentHeartPoint - 1];
                        ctx.beginPath();
                        ctx.moveTo(prevPoint.x, prevPoint.y);
                        ctx.lineTo(nextPoint.x, nextPoint.y);
                        ctx.strokeStyle = '#FFB6C1';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                    }

                    currentHeartPoint++;
                    document.getElementById('currentPoint').textContent = currentHeartPoint + 1;

                    if (currentHeartPoint === numPoints) {
                        // Conectar √∫ltimo con primero
                        const firstPoint = heartPoints[0];
                        ctx.beginPath();
                        ctx.moveTo(nextPoint.x, nextPoint.y);
                        ctx.lineTo(firstPoint.x, firstPoint.y);
                        ctx.strokeStyle = '#FFB6C1';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        
                        setTimeout(() => nextChallenge(), 1000);
                    }
                }
            };
        }

        function initPhotoMatch(photos) {
            // NOTA: Las fotos deben estar en la misma carpeta que este HTML
            // Nombra tus fotos como: foto1.jpg, foto2.jpg, foto3.jpg
            
            photoMatches = [];
            selectedPhotos = [];
            
            photos.forEach((photo, index) => {
                photoMatches.push(
                    { id: index * 2, photoIndex: index, half: 'left' },
                    { id: index * 2 + 1, photoIndex: index, half: 'right' }
                );
            });
            
            photoMatches.sort(() => Math.random() - 0.5);
            
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = photoMatches.map((match, i) => {
                const bgPosition = match.half === 'left' ? 'left center' : 'right center';
                return `<div class="photo-piece" onclick="selectPhoto(${i})" data-photo-index="${match.photoIndex}" data-half="${match.half}" style="background-image: url('${photos[match.photoIndex]}'); background-position: ${bgPosition};"></div>`;
            }).join('');

            // Verificar carga de im√°genes
            setTimeout(() => {
                const pieces = grid.querySelectorAll('.photo-piece');
                let hasErrors = false;
                pieces.forEach((piece) => {
                    const bgImage = piece.style.backgroundImage;
                    if (bgImage && bgImage !== 'none') {
                        const url = bgImage.slice(5, -2);
                        const img = new Image();
                        img.onerror = () => {
                            piece.style.backgroundImage = 'none';
                            piece.innerHTML = 'üñºÔ∏è';
                            piece.style.display = 'flex';
                            piece.style.alignItems = 'center';
                            piece.style.justifyContent = 'center';
                            piece.style.fontSize = '2em';
                            piece.style.background = 'linear-gradient(135deg, #FFE5E5, #FFB6B6)';
                            hasErrors = true;
                        };
                        img.src = url;
                    }
                });
                if (hasErrors) {
                    ErrorHandler.showToast('Algunas fotos no se pudieron cargar. Aseg√∫rate de que las im√°genes est√©n en la misma carpeta.', 'error');
                }
            }, 100);
        }

        function selectPhoto(index) {
            const pieces = document.querySelectorAll('.photo-piece');
            const piece = pieces[index];
            
            if (piece.classList.contains('matched')) return;
            
            if (selectedPhotos.length === 0) {
                piece.classList.add('selected');
                selectedPhotos.push(index);
            } else if (selectedPhotos.length === 1) {
                if (selectedPhotos[0] === index) return;
                
                const firstPiece = pieces[selectedPhotos[0]];
                const firstPhotoIndex = firstPiece.dataset.photoIndex;
                const firstHalf = firstPiece.dataset.half;
                const secondPhotoIndex = piece.dataset.photoIndex;
                const secondHalf = piece.dataset.half;
                
                if (firstPhotoIndex === secondPhotoIndex && firstHalf !== secondHalf) {
                    piece.classList.add('matched');
                    firstPiece.classList.add('matched');
                    firstPiece.classList.remove('selected');
                    
                    setTimeout(() => {
                        if (document.querySelectorAll('.photo-piece.matched').length === photoMatches.length) {
                            setTimeout(() => nextChallenge(), 1000);
                        }
                    }, 500);
                } else {
                    piece.classList.add('selected');
                    setTimeout(() => {
                        piece.classList.remove('selected');
                        firstPiece.classList.remove('selected');
                    }, 1000);
                }
                
                selectedPhotos = [];
            }
        }

        let sequencePattern = [];
        let userSequence = [];

        function initSequenceGame(length) {
            sequencePattern = [];
            userSequence = [];
            const emojis = ['‚ù§Ô∏è', 'üíï', 'üíñ', 'üíó', 'üíì'];
            
            // Generar secuencia aleatoria
            for (let i = 0; i < length; i++) {
                sequencePattern.push(emojis[Math.floor(Math.random() * emojis.length)]);
            }
            
            // Mostrar secuencia
            showSequence();
        }

        function showSequence() {
            const display = document.getElementById('sequenceDisplay');
            let index = 0;
            
            display.textContent = 'üëÄ Observa...';
            
            const interval = setInterval(() => {
                if (index < sequencePattern.length) {
                    display.textContent = sequencePattern[index];
                    index++;
                } else {
                    clearInterval(interval);
                    display.textContent = '¬°Ahora rep√≠tela!';
                    showSequenceButtons();
                }
            }, 800);
        }

        function showSequenceButtons() {
            const container = document.getElementById('sequenceButtons');
            const emojis = ['‚ù§Ô∏è', 'üíï', 'üíñ', 'üíó', 'üíì'];
            
            container.style.display = 'grid';
            container.innerHTML = emojis.map(emoji => 
                `<div class="heart-item" onclick="selectSequenceEmoji('${emoji}')" style="cursor: pointer;">${emoji}</div>`
            ).join('');
        }

        function selectSequenceEmoji(emoji) {
            userSequence.push(emoji);
            const display = document.getElementById('sequenceDisplay');
            display.textContent = userSequence.join(' ');
            
            // Verificar cada paso
            const currentIndex = userSequence.length - 1;
            if (userSequence[currentIndex] !== sequencePattern[currentIndex]) {
                display.textContent = '‚ùå Incorrecto';
                ErrorHandler.showToast('Int√©ntalo de nuevo', 'error');
                setTimeout(() => {
                    userSequence = [];
                    display.textContent = '¬°Intenta de nuevo!';
                }, 1500);
                return;
            }
            
            // Si complet√≥ toda la secuencia correctamente
            if (userSequence.length === sequencePattern.length) {
                display.textContent = '‚úÖ ¬°Perfecto!';
                ErrorHandler.showToast('¬°Secuencia correcta! üéâ', 'success');
                setTimeout(() => nextChallenge(), 1500);
            }
        }

        function nextChallenge() {
            currentChallenge++;
            
            // Guardar progreso autom√°ticamente
            ErrorHandler.safeLocalStorage.set('loveGameProgress', currentChallenge);
            
            if (currentChallenge < challenges.length) {
                renderChallenge();
            }
        }

        // ========================================
        // INICIALIZACI√ìN Y PERSISTENCIA
        // ========================================
        
        // Cargar progreso guardado
        window.addEventListener('load', () => {
            const savedProgress = ErrorHandler.safeLocalStorage.get('loveGameProgress', 0);
            if (savedProgress > 0 && savedProgress < challenges.length) {
                if (confirm(`¬øQuieres continuar desde el desaf√≠o ${savedProgress + 1}?`)) {
                    currentChallenge = savedProgress;
                }
            }
            renderChallenge();
        });

        // Guardar al salir de la p√°gina
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && currentChallenge < challenges.length) {
                ErrorHandler.safeLocalStorage.set('loveGameProgress', currentChallenge);
            }
        });

        // Prevenir cierre accidental
        window.addEventListener('beforeunload', (e) => {
            if (currentChallenge > 0 && currentChallenge < challenges.length - 1) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Initialize (comentado porque ahora lo hacemos en window.load)
        // renderChallenge();
    </script>
</body>
</html>