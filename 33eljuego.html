<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>33: El Juego üíù</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Quicksand:wght@300;400;600&family=Fredoka+One&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #BFF8F1;
            --primary-dark: #9DE5DD;
            --accent: #FFB6C1;
            --text: #2C3E50;
            --light: #FFFFFF;
            --shadow: rgba(191, 248, 241, 0.3);
            --error: #FF6B6B;
            --success: #4CAF50;
        }

        /* Toast/Notification System */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 300px;
        }

        .toast {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
            border-left: 4px solid;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--error);
        }

        .toast.info {
            border-left-color: var(--primary);
        }

        .toast-icon {
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .toast-message {
            font-size: 0.9em;
            color: var(--text);
            flex: 1;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #BFF8F1 0%, #E8F8F5 50%, #FFE5EC 100%);
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden;
        }

        /* Portada */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, #BFF8F1 0%, #E8F8F5 50%, #FFE5EC 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 1s ease;
        }

        .welcome-screen.hidden {
            animation: fadeOut 0.5s ease forwards;
            pointer-events: none;
        }

        .welcome-content {
            text-align: center;
            padding: 40px 30px;
            max-width: 500px;
        }

        .welcome-icon {
            font-size: 5em;
            margin-bottom: 30px;
            animation: float 3s ease-in-out infinite;
        }

        .welcome-title {
            font-family: 'Fredoka One', cursive;
            font-size: 2.5em;
            color: var(--text);
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(255, 182, 193, 0.3);
            line-height: 1.3;
        }

        .welcome-subtitle {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 40px;
            font-weight: 300;
            line-height: 1.6;
        }

        .start-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border: none;
            padding: 20px 50px;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Quicksand', sans-serif;
            color: var(--text);
            box-shadow: 0 10px 30px var(--shadow);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .start-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--shadow);
        }

        .start-btn:active {
            transform: translateY(-2px);
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-20px);
            }
        }

        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            padding: 30px 0 20px;
            animation: fadeInDown 0.8s ease;
        }

        .header h1 {
            font-family: 'Fredoka One', cursive;
            font-size: 2.2em;
            color: var(--text);
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(255, 182, 193, 0.3);
        }

        .header .subtitle {
            font-size: 1em;
            color: #666;
            font-weight: 300;
        }

        .progress-container {
            background: white;
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 8px 30px var(--shadow);
            animation: fadeIn 1s ease;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 0.95em;
        }

        .progress-bar {
            height: 12px;
            background: #E8F8F5;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 10px;
            transition: width 0.6s cubic-bezier(0.65, 0, 0.35, 1);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        .card {
            background: white;
            border-radius: 25px;
            padding: 35px 25px;
            box-shadow: 0 10px 40px var(--shadow);
            animation: slideUp 0.6s ease;
            margin-bottom: 20px;
        }

        .challenge-number {
            display: inline-block;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: var(--text);
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
            margin-bottom: 20px;
        }

        .challenge-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.6em;
            margin-bottom: 15px;
            color: var(--text);
        }

        .challenge-description {
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option-btn {
            background: linear-gradient(135deg, #F8FBFF 0%, var(--primary) 100%);
            border: 2px solid var(--primary-dark);
            padding: 18px;
            border-radius: 15px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Quicksand', sans-serif;
            font-weight: 500;
            color: var(--text);
            text-align: left;
        }

        .option-btn:hover {
            transform: translateX(8px);
            box-shadow: 0 5px 20px var(--shadow);
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }

        .option-btn.correct {
            background: linear-gradient(135deg, #A8E6CF 0%, #77DD77 100%);
            border-color: #4CAF50;
            animation: correctPulse 0.5s ease;
        }

        .option-btn.incorrect {
            background: linear-gradient(135deg, #FFB6B6 0%, #FF8A8A 100%);
            border-color: #F44336;
            animation: shake 0.5s ease;
        }

        .input-field {
            width: 100%;
            padding: 18px;
            border: 2px solid var(--primary-dark);
            border-radius: 15px;
            font-size: 1em;
            font-family: 'Quicksand', sans-serif;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #F8FBFF 0%, #FFFFFF 100%);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 4px rgba(255, 182, 193, 0.2);
            transform: scale(1.02);
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            border: none;
            padding: 18px 35px;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Quicksand', sans-serif;
            color: var(--text);
            width: 100%;
            margin-top: 15px;
            box-shadow: 0 5px 20px var(--shadow);
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px var(--shadow);
        }

        .submit-btn:active {
            transform: translateY(-1px);
        }

        /* Navigation buttons */
        .nav-btn {
            background: white;
            border: 2px solid var(--primary-dark);
            padding: 12px 25px;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Quicksand', sans-serif;
            color: var(--text);
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 120px;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            transform: translateY(-2px);
            box-shadow: 0 5px 20px var(--shadow);
        }

        .nav-btn:active {
            transform: translateY(0);
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        @media (max-width: 480px) {
            .nav-btn {
                font-size: 0.95em;
                padding: 10px 20px;
                min-width: 100px;
            }
        }


        /* Memory Game */
        .memory-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .memory-card {
            aspect-ratio: 1;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .memory-card:hover {
            transform: scale(1.05);
        }

        .memory-card.flipped {
            background: white;
            border-color: var(--accent);
        }

        .memory-card.matched {
            background: linear-gradient(135deg, #A8E6CF, #77DD77);
            border-color: #4CAF50;
            animation: matchPulse 0.5s ease;
        }

        /* Find Hearts Game */
        .hearts-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .heart-item {
            font-size: 3em;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 10px;
            border-radius: 15px;
        }

        .heart-item:hover {
            transform: scale(1.2);
        }

        .heart-item.found {
            animation: heartBounce 0.5s ease;
            transform: scale(1.3);
        }

        .hearts-counter {
            text-align: center;
            font-size: 1.3em;
            font-weight: 600;
            color: var(--accent);
            margin-top: 15px;
        }

        /* Slider Game */
        .slider-container {
            margin: 30px 0;
        }

        .love-slider {
            width: 100%;
            height: 15px;
            border-radius: 10px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            outline: none;
            -webkit-appearance: none;
        }

        .love-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--accent);
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .slider-value {
            text-align: center;
            font-size: 2.5em;
            font-weight: 700;
            color: var(--accent);
            margin: 20px 0;
        }

        /* Reaction Game */
        .reaction-area {
            background: linear-gradient(135deg, #F8FBFF, #E8F8F5);
            border-radius: 20px;
            padding: 60px 20px;
            text-align: center;
            margin: 20px 0;
            border: 3px dashed var(--primary-dark);
        }

        /* Puzzle Game */
        .puzzle-pieces {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .puzzle-piece {
            aspect-ratio: 1;
            background: linear-gradient(135deg, var(--primary), white);
            border: 2px solid var(--primary-dark);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .puzzle-piece:hover {
            transform: scale(1.1);
            background: linear-gradient(135deg, var(--accent), white);
        }

        .puzzle-piece.correct-position {
            background: linear-gradient(135deg, #A8E6CF, #77DD77);
            border-color: #4CAF50;
        }

        /* Timeline/Chronological Game */
        .timeline-container {
            margin: 30px 0;
        }

        .timeline-item {
            background: linear-gradient(135deg, #F8FBFF 0%, var(--primary) 100%);
            border: 2px solid var(--primary-dark);
            padding: 15px 20px;
            border-radius: 15px;
            margin: 10px 0;
            cursor: move;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .timeline-item:hover {
            transform: translateX(8px);
            box-shadow: 0 5px 20px var(--shadow);
        }

        .timeline-item.dragging {
            opacity: 0.5;
        }

        .timeline-item.correct-order {
            background: linear-gradient(135deg, #A8E6CF 0%, #77DD77 100%);
            border-color: #4CAF50;
        }

        /* Draw Heart Game (Canvas) */
        .canvas-container {
            position: relative;
            margin: 20px auto;
            max-width: 300px;
        }

        #heartCanvas {
            border: 3px solid var(--primary-dark);
            border-radius: 20px;
            background: white;
            cursor: crosshair;
            width: 100%;
            height: auto;
        }

        .canvas-instruction {
            text-align: center;
            margin-top: 15px;
            color: #666;
            font-size: 0.9em;
        }

        /* Photo Match Game */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 20px 0;
        }

        .photo-piece {
            aspect-ratio: 3/4; /* Optimizado para fotos verticales en m√≥vil */
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid transparent;
            overflow: hidden;
            background-size: 200% auto; /* Ampliado al 200% para mostrar solo la mitad */
            background-position: center;
            min-height: 180px; /* Altura m√≠nima para mejor visualizaci√≥n */
            position: relative;
        }
        
        /* Efecto de l√≠nea de corte para indicar que es una mitad */
        .photo-piece::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, 
                transparent 0%, 
                rgba(255, 255, 255, 0.5) 20%, 
                rgba(255, 255, 255, 0.8) 50%, 
                rgba(255, 255, 255, 0.5) 80%, 
                transparent 100%);
            pointer-events: none;
        }
        
        .photo-piece[data-half="left"]::after {
            right: 0;
        }
        
        .photo-piece[data-half="right"]::after {
            left: 0;
        }

        .photo-piece:hover {
            transform: scale(1.05);
            border-color: var(--accent);
        }

        .photo-piece.selected {
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--shadow);
        }

        .photo-piece.matched {
            border-color: #4CAF50;
            animation: matchPulse 0.5s ease;
        }

        /* Final Screen */
        .final-screen {
            text-align: center;
            padding: 40px 20px;
            animation: fadeIn 1.5s ease;
        }

        .celebration {
            font-size: 4em;
            margin: 20px 0;
            animation: bounce 1s ease infinite;
        }

        .final-screen h2 {
            font-family: 'Playfair Display', serif;
            font-size: 2.2em;
            color: var(--text);
            margin: 30px 0 20px;
        }

        .final-message {
            font-size: 1.2em;
            line-height: 1.8;
            color: #666;
            margin: 30px 0;
            padding: 30px;
            background: linear-gradient(135deg, #F8FBFF, #FFE5EC);
            border-radius: 20px;
            border: 2px solid var(--accent);
        }

        .reveal-container {
            margin: 40px 0;
            padding: 30px;
            background: white;
            border-radius: 25px;
            box-shadow: 0 10px 40px var(--shadow);
            animation: slideUp 1s ease 1.5s backwards;
        }

        .reveal-title {
            font-size: 1.5em;
            color: var(--accent);
            margin-bottom: 20px;
            font-weight: 600;
        }

        .alhambra-icon {
            font-size: 5em;
            margin: 20px 0;
            animation: glow 2s ease infinite;
        }

        .dinner-details {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            padding: 25px;
            border-radius: 20px;
            margin: 20px 0;
        }

        .dinner-details h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8em;
            margin-bottom: 15px;
        }

        .dinner-details p {
            font-size: 1.1em;
            margin: 10px 0;
            font-weight: 500;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @keyframes matchPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes heartBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.5); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        @keyframes glow {
            0%, 100% { 
                text-shadow: 0 0 10px var(--accent),
                            0 0 20px var(--accent),
                            0 0 30px var(--accent);
            }
            50% { 
                text-shadow: 0 0 20px var(--accent),
                            0 0 30px var(--accent),
                            0 0 40px var(--accent);
            }
        }
    
        /* ============================================
           SISTEMA DE BLOQUEO CON RETOS
           ============================================ */
        
        .lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #BFF8F1 0%, #E8F8F5 50%, #FFE5EC 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100000;
            padding: 20px;
        }

        .lock-screen.unlocked {
            display: none;
        }

        #gameContent.locked {
            display: none;
        }

        .lock-container {
            background: white;
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .lock-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5em;
            color: var(--text);
            margin-bottom: 10px;
        }

        .lock-subtitle {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 30px;
        }

        .countdown {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
        }

        .countdown-label {
            font-size: 0.9em;
            color: var(--text);
            margin-bottom: 10px;
            font-weight: 600;
        }

        .countdown-timer {
            font-family: 'Fredoka One', cursive;
            font-size: 2em;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .password-section {
            margin-bottom: 20px;
        }

        .password-input {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            border: 2px solid var(--primary);
            border-radius: 15px;
            text-align: center;
            font-family: 'Courier New', monospace;
            letter-spacing: 3px;
            transition: all 0.3s;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 20px var(--shadow);
        }

        .password-hint {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 1.5em;
            letter-spacing: 5px;
            flex-wrap: wrap;
        }

        .password-hint span {
            width: 30px;
            height: 40px;
            background: #f0f0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--text);
            transition: all 0.3s;
        }

        .password-hint span.revealed {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            transform: scale(1.1);
        }

        .progress-info {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 20px;
        }

        .extra-info {
            font-size: 0.85em;
            color: #999;
            margin-top: 5px;
        }

        .btn {
            padding: 15px 30px;
            font-size: 1em;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-family: 'Quicksand', sans-serif;
            font-weight: 600;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: var(--text);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px var(--shadow);
        }

        .btn-secondary {
            background: white;
            color: var(--text);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--primary);
        }

        .challenges-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100001;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .challenges-modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 25px;
            max-width: 700px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.8);
            transition: transform 0.3s;
        }

        .challenges-modal.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-family: 'Playfair Display', serif;
            font-size: 2em;
            color: var(--text);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2em;
            cursor: pointer;
            color: #999;
            transition: color 0.3s;
            line-height: 1;
        }

        .close-btn:hover {
            color: var(--text);
        }

        .challenges-grid {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .challenge-category {
            margin-bottom: 20px;
        }

        .category-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3em;
            color: var(--text);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary);
        }

        .challenge-item {
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            padding: 15px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .challenge-item:hover {
            transform: translateX(5px);
            border-color: var(--primary);
        }

        .challenge-item.completed {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            opacity: 0.8;
        }

        .challenge-item.blocked {
            background: #e0e0e0;
            opacity: 0.5;
            pointer-events: none;
        }

        .challenge-item.extra {
            border-left: 4px solid var(--accent);
        }

        .challenge-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--accent);
            flex-shrink: 0;
        }

        .challenge-checkbox:disabled {
            cursor: not-allowed;
        }

        .challenge-icon {
            font-size: 1.5em;
            min-width: 30px;
            text-align: center;
            flex-shrink: 0;
        }

        .challenge-text {
            flex: 1;
            font-size: 1em;
        }

        .challenge-item.completed .challenge-text {
            text-decoration: line-through;
            color: white;
        }

        .challenge-item.blocked .challenge-text {
            text-decoration: line-through;
            color: #999;
        }

        .challenge-reward {
            font-size: 0.8em;
            color: var(--accent);
            font-weight: bold;
            background: white;
            padding: 5px 10px;
            border-radius: 10px;
            flex-shrink: 0;
        }

        .challenge-item.completed .challenge-reward {
            background: rgba(255,255,255,0.3);
            color: white;
        }

        .challenge-item.extra .challenge-reward {
            background: var(--accent);
            color: white;
        }

        .challenge-item.extra.completed .challenge-reward {
            background: rgba(255,255,255,0.3);
        }

        .error-message {
            background: var(--error);
            color: white;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .success-message {
            background: var(--success);
            color: white;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
        }

        @media (max-width: 600px) {
            .lock-container {
                padding: 30px 20px;
            }

            .lock-title {
                font-size: 2em;
            }

            .countdown-timer {
                font-size: 1.5em;
            }

            .password-hint {
                font-size: 1.2em;
                gap: 5px;
            }

            .password-hint span {
                width: 25px;
                height: 35px;
            }

            .modal-content {
                padding: 20px;
            }

            .challenge-item {
                padding: 12px;
            }
        }

    </style>
</head>
<body>
    <!-- SISTEMA DE BLOQUEO -->
    <div class="lock-screen" id="lockScreen">
        <div class="lock-container">
            <h1 class="lock-title">üîí Bloqueado</h1>
            <p class="lock-subtitle">¬°Tu regalo de San Valent√≠n est√° esper√°ndote!</p>

            <div class="countdown">
                <div class="countdown-label">Se desbloquea en:</div>
                <div class="countdown-timer" id="countdownTimer">Calculando...</div>
            </div>

            <div class="password-section">
                <div class="password-hint" id="passwordHint">
                    <span>_</span>
                    <span>_</span>
                    <span>_</span>
                    <span>_</span>
                    <span>_</span>
                    <span>_</span>
                    <span>_</span>
                    <span>_</span>
                </div>
                <div class="progress-info" id="progressInfo">0 de 8 letras reveladas</div>
                <div class="extra-info" id="extraInfo">0/3 retos extra usados</div>
                <input 
                    type="text" 
                    class="password-input" 
                    id="passwordInput" 
                    placeholder="Introduce la contrase√±a"
                    maxlength="8"
                >
                <div id="passwordMessage"></div>
            </div>

            <button class="btn btn-primary" onclick="LockSystem.checkPassword()">üîì Desbloquear</button>
            <button class="btn btn-secondary" onclick="LockSystem.openChallenges()">üìã Ver Retos</button>
        </div>
    </div>

    <!-- Modal de Retos -->
    <div class="challenges-modal" id="challengesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">üéØ Retos en Granada</h2>
                <button class="close-btn" onclick="LockSystem.closeChallenges()">&times;</button>
            </div>

            <div class="challenges-grid">
                <!-- Retos Principales -->
                <div class="challenge-category">
                    <h3 class="category-title">üéØ Retos Principales (8)</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">Completa estos retos para revelar la contrase√±a</p>
                    
                    <div class="challenge-item" data-challenge="0" data-type="main">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(0, 'main')">
                        <span class="challenge-icon">üì∏</span>
                        <span class="challenge-text">Consigue una foto de alguna frase de Dellafuente en las calles de Granada</span>
                        <span class="challenge-reward">+Letra</span>
                    </div>
                    
                    <div class="challenge-item" data-challenge="1" data-type="main">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(1, 'main')">
                        <span class="challenge-icon">üç∫</span>
                        <span class="challenge-text">Consume tu primera cerveza y tapa</span>
                        <span class="challenge-reward">+Letra</span>
                    </div>
                    
                    <div class="challenge-item" data-challenge="2" data-type="main">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(2, 'main')">
                        <span class="challenge-icon">üíã</span>
                        <span class="challenge-text">Dame un beso cuando menos me lo espere</span>
                        <span class="challenge-reward">+Letra</span>
                    </div>
                    
                    <div class="challenge-item" data-challenge="3" data-type="main">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(3, 'main')">
                        <span class="challenge-icon">üåÖ</span>
                        <span class="challenge-text">Hacernos una foto juntos en el Mirador de San Nicol√°s</span>
                        <span class="challenge-reward">+Letra</span>
                    </div>
                    
                    <div class="challenge-item" data-challenge="4" data-type="main">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(4, 'main')">
                        <span class="challenge-icon">üíù</span>
                        <span class="challenge-text">Dime "te quiero" en un momento inesperado</span>
                        <span class="challenge-reward">+Letra</span>
                    </div>
                    
                    <div class="challenge-item" data-challenge="5" data-type="main">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(5, 'main')">
                        <span class="challenge-icon">üéÅ</span>
                        <span class="challenge-text">Comprame algun detalle de recuerdo del viaje</span>
                        <span class="challenge-reward">+Letra</span>
                    </div>
                    
                    <div class="challenge-item" data-challenge="6" data-type="main">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(6, 'main')">
                        <span class="challenge-icon">üòÇ</span>
                        <span class="challenge-text">Hazme reir con un chiste malo</span>
                        <span class="challenge-reward">+Letra</span>
                    </div>
                    
                    <div class="challenge-item" data-challenge="7" data-type="main">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(7, 'main')">
                        <span class="challenge-icon">‚úä</span>
                        <span class="challenge-text">Ganame 3 veces seguidas al piedra, papel y tijera</span>
                        <span class="challenge-reward">+Letra</span>
                    </div>
                </div>

                <!-- Retos Extra -->
                <div class="challenge-category">
                    <h3 class="category-title">‚≠ê Retos Extra (m√°ximo 3)</h3>
                    <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">Si alg√∫n reto principal se complica, usa estos alternativos</p>
                    
                    <div class="challenge-item extra" data-challenge="0" data-type="extra">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(0, 'extra')">
                        <span class="challenge-icon">üé®</span>
                        <span class="challenge-text">Encuentra una calle bonita del Albaic√≠n y fotograf√≠ala</span>
                        <span class="challenge-reward">Extra</span>
                    </div>
                    
                    <div class="challenge-item extra" data-challenge="1" data-type="extra">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(1, 'extra')">
                        <span class="challenge-icon">üç∑</span>
                        <span class="challenge-text">Bebe una copa de vino</span>
                        <span class="challenge-reward">Extra</span>
                    </div>
                    
                    <div class="challenge-item extra" data-challenge="2" data-type="extra">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(2, 'extra')">
                        <span class="challenge-icon">üíô</span>
                        <span class="challenge-text">Encuentra una puerta azul y dame un beso delante</span>
                        <span class="challenge-reward">Extra</span>
                    </div>
                    
                    <div class="challenge-item extra" data-challenge="3" data-type="extra">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(3, 'extra')">
                        <span class="challenge-icon">‚ù§Ô∏è</span>
                        <span class="challenge-text">Consigue una foto de algun corazon por las calles de Granada</span>
                        <span class="challenge-reward">Extra</span>
                    </div>
                    
                    <div class="challenge-item extra" data-challenge="4" data-type="extra">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(4, 'extra')">
                        <span class="challenge-icon">ü§ó</span>
                        <span class="challenge-text">Dame un abrazo cuando menos lo espere</span>
                        <span class="challenge-reward">Extra</span>
                    </div>
                    
                    <div class="challenge-item extra" data-challenge="5" data-type="extra">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(5, 'extra')">
                        <span class="challenge-icon">üí≠</span>
                        <span class="challenge-text">Dime 3 cosas que te gustan de mi</span>
                        <span class="challenge-reward">Extra</span>
                    </div>
                    
                    <div class="challenge-item extra" data-challenge="6" data-type="extra">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(6, 'extra')">
                        <span class="challenge-icon">üíÉ</span>
                        <span class="challenge-text">Baila en mitad de la calle</span>
                        <span class="challenge-reward">Extra</span>
                    </div>
                    
                    <div class="challenge-item extra" data-challenge="7" data-type="extra">
                        <input type="checkbox" class="challenge-checkbox" onchange="LockSystem.toggleChallenge(7, 'extra')">
                        <span class="challenge-icon">üí™</span>
                        <span class="challenge-text">Ganame un pulso chino</span>
                        <span class="challenge-reward">Extra</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contenedor del juego original -->
    <div id="gameContent" class="locked">

    <!-- Pantalla de Bienvenida -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-content">
            <div class="welcome-icon">üíù</div>
            <h1 class="welcome-title">33: El Juego</h1>
            <p class="welcome-subtitle">Un viaje por nuestra historia juntos.<br>Cada desaf√≠o es un recuerdo especial.</p>
            <button class="start-btn" onclick="startGame()">Comenzar ‚ú®</button>
        </div>
    </div>

    <!-- Toast Container para notificaciones -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container">
        <div class="header">
            <h1>33: El Juego üíù</h1>
            <p class="subtitle">Un viaje por nuestros momentos especiales</p>
        </div>

        <div class="progress-container">
            <div class="progress-info">
                <span>Progreso</span>
                <span id="progressText">0/33</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>

        <div class="card" id="challengeCard"></div>
        
        <!-- Botones de navegaci√≥n -->
        <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: space-between;">
            <button id="backBtn" class="nav-btn" onclick="goBack()" style="display: none;">
                ‚Üê Atr√°s
            </button>
            <button id="nextBtn" class="nav-btn" onclick="goNext()" style="display: none;">
                Siguiente ‚Üí
            </button>
        </div>
    </div>

    <script>
        // ========================================
        // SISTEMA DE GESTI√ìN DE ERRORES
        // ========================================
        class ErrorHandler {
            static showToast(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    success: '‚úÖ',
                    error: '‚ùå',
                    info: '‚ÑπÔ∏è'
                };
                
                toast.innerHTML = `
                    <span class="toast-icon">${icons[type]}</span>
                    <span class="toast-message">${message}</span>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

            static validateInput(value) {
                if (!value || value.trim() === '') {
                    this.showToast('Por favor completa este campo', 'error');
                    return false;
                }
                return true;
            }

            static handleImageError(img, container) {
                img.onerror = null;
                container.classList.add('image-error');
                container.innerHTML = 'üñºÔ∏è';
                this.showToast('Algunas fotos no se pudieron cargar', 'error');
            }

            static safeLocalStorage = {
                get: function(key, defaultValue = null) {
                    try {
                        const item = localStorage.getItem(key);
                        return item ? JSON.parse(item) : defaultValue;
                    } catch (error) {
                        console.error('Error al leer de localStorage:', error);
                        return defaultValue;
                    }
                },
                set: function(key, value) {
                    try {
                        localStorage.setItem(key, JSON.stringify(value));
                        return true;
                    } catch (error) {
                        if (error.name === 'QuotaExceededError') {
                            ErrorHandler.showToast('Espacio de almacenamiento lleno', 'error');
                        } else {
                            console.error('Error al guardar en localStorage:', error);
                        }
                        return false;
                    }
                },
                remove: function(key) {
                    try {
                        localStorage.removeItem(key);
                        return true;
                    } catch (error) {
                        console.error('Error al eliminar de localStorage:', error);
                        return false;
                    }
                }
            };
        }

        // ========================================
        // SISTEMA DE CONFETTI
        // ========================================
        function createConfetti() {
            const colors = ['#BFF8F1', '#FFB6C1', '#FFE5EC', '#E8F8F5', '#FFDEE9'];
            const confettiCount = 50;

            for (let i = 0; i < confettiCount; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.style.position = 'fixed';
                    confetti.style.width = (Math.random() * 10 + 5) + 'px';
                    confetti.style.height = confetti.style.width;
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.top = '-20px';
                    confetti.style.borderRadius = '50%';
                    confetti.style.zIndex = '9999';
                    confetti.style.pointerEvents = 'none';
                    confetti.style.animation = `confettiFall ${2 + Math.random() * 2}s linear forwards`;
                    document.body.appendChild(confetti);

                    setTimeout(() => confetti.remove(), 4000);
                }, i * 30);
            }
        }

        // Agregar animaci√≥n de confetti al CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes confettiFall {
                to {
                    transform: translateY(100vh) rotate(${Math.random() * 360}deg);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // ========================================
        // PORTADA Y INICIO DEL JUEGO
        // ========================================
        function startGame() {
            const welcomeScreen = document.getElementById('welcomeScreen');
            welcomeScreen.classList.add('hidden');
            setTimeout(() => {
                welcomeScreen.remove();
            }, 500);
        }

        // ========================================
        // VARIABLES DEL JUEGO
        // ========================================
        let currentChallenge = 0;
        let maxChallengeReached = 0; // Para saber hasta qu√© desaf√≠o ha llegado
        let memoryCards = [];
        let memoryFlipped = [];
        let memoryMatched = [];
        let heartsFound = 0;
        let reactionStartTime = 0;
        let reactionTimeout = 500; // Valor por defecto
        let puzzleOrder = [];
        let draggedElement = null;
        let heartPoints = [];
        let currentHeartPoint = 0;
        let photoMatches = [];
        let selectedPhotos = [];
        let wordMatches = [];
        let selectedWords = [];

        const challenges = [
            // DESAF√çO 1: Inicio - primer encuentro (input)
            {
                type: 'input',
                title: '¬øQu√© d√≠a es nuestro aniversario?',
                description: 'El d√≠a que todo empez√≥... üíã',
                answer: '3 de octubre'
            },

            // DESAF√çO 2: El cangrejo (multiple) - antes del primer beso, fue lo primero
            {
                type: 'multiple',
                title: '¬øQu√© estaba haciendo cuando me viste por primera vez en la piscina?',
                description: 'Seg√∫n t√∫, fue muy gracioso... üòÇ',
                options: [
                    'Jugando al voley',
                    'Haciendo el cangrejo',
                    'Tir√°ndome de bomba',
                    'Nadando estilo libre'
                ],
                correct: 1
            },

            // DESAF√çO 3: PSV-Sevilla (input ‚Üí usamos multiple porque es el formato original)
            {
                type: 'multiple',
                title: '¬øContra qu√© equipo jugaba el Sevilla el d√≠a de nuestro primer beso?',
                description: 'Aquel partido memorable... ‚öΩ',
                options: [
                    'PSV Eindhoven',
                    'Ajax',
                    'Manchester United',
                    'Arsenal'
                ],
                correct: 0
            },

            // DESAF√çO 4: Primera cita - cine (multiple)
            {
                type: 'multiple',
                title: '¬øQu√© pel√≠cula vimos en nuestra primera cita?',
                description: 'Nada m√°s rom√°ntico que... üé¨',
                options: [
                    'El Conjuro',
                    'Terrifier',
                    'Saw X',
                    'Scream VI'
                ],
                correct: 2
            },

            // DESAF√çO 5: MINIJUEGO 1 - Puzzle n√∫meros (mini, tras los primeros momentos)
            {
                type: 'puzzle',
                title: 'Ordena estos n√∫meros',
                description: 'Del 1 al 9... üß©',
                numbers: [5, 2, 8, 1, 9, 3, 7, 4, 6]
            },

            // DESAF√çO 6: An√©cdota "te quiero" viendo al Sevilla (input)
            {
                type: 'input',
                title: '¬øC√≥mo me llamas cari√±osamente?',
                description: 'Escribe uno de nuestros apodos... üíï',
                answer: 'gordi'
            },

            // DESAF√çO 7: An√©cdota legendaria En Nesyri (multiple)
            {
                type: 'multiple',
                title: '¬øQu√© me respondiste cuando te dije "te quiero" por primera vez viendo al Sevilla?',
                description: 'Nunca lo olvidar√©... üòÇ‚öΩ',
                options: [
                    'Control hist√≥rico de En Nesyri',
                    'Yo tambi√©n te quiero',
                    'Gol del Sevilla',
                    'Espera que est√°n atacando'
                ],
                correct: 0
            },

            // DESAF√çO 8: Primera escapada - San Nicol√°s (input)
            {
                type: 'multiple',
                title: '¬øCu√°l fue nuestro primer destino juntos?',
                description: 'Nuestra primera escapada rom√°ntica... üå≤',
                options: [
                    'Cazorla',
                    'Sierra de Grazalema',
                    'San Nicol√°s del Puerto',
                    'Aracena'
                ],
                correct: 2
            },

            // DESAF√çO 9: Canci√≥n favorita (input)
            {
                type: 'input',
                title: '¬øCu√°l es nuestra canci√≥n favorita?',
                description: 'La que siempre nos hace sonre√≠r... üåô',
                answer: 'con la luna llena'
            },

            // DESAF√çO 10: MINIJUEGO 2 - TapHearts (mini, momento de energ√≠a a mitad de la primera etapa)
            {
                type: 'tapHearts',
                title: 'Dale a todos los corazones lo m√°s r√°pido posible',
                description: 'Tienes 3 segundos para tocar los 12 corazones... ‚ù§Ô∏è‚ö°',
                total: 12,
                timeLimit: 3000
            },

            // DESAF√çO 11: Montana - primer verano (input)
            {
                type: 'input',
                title: '¬øD√≥nde te fuiste el primer verano que est√°bamos juntos?',
                description: 'Aquel viaje largo... ‚úàÔ∏è',
                answer: 'montana'
            },

            // DESAF√çO 12: Costa Ballena - reencuentro tras Montana (input)
            {
                type: 'input',
                title: '¬øA qu√© playa fuimos el primer finde cuando volviste de Montana?',
                description: 'Aquel reencuentro... üåä',
                answer: 'costa ballena'
            },

            // DESAF√çO 13: Cazorla - artista del viaje (multiple ‚Üí ya tiene Granada antes)
            {
                type: 'multiple',
                title: '¬øCu√°ntas veces habremos estado en Granada cuando leas esto?',
                description: 'Contando el d√≠a de hoy... üè∞',
                options: [
                    '1 vez',
                    '2 veces',
                    '3 veces',
                    '4 veces'
                ],
                correct: 2
            },

            // DESAF√çO 14: Artista Cazorla (input)
            {
                type: 'input',
                title: '¬øQu√© artista escuch√°bamos de camino a Cazorla?',
                description: 'Ese viaje de spa y relax... üéµ',
                answer: 'pablo alboran'
            },

            // DESAF√çO 15: MINIJUEGO 3 - Timeline cronol√≥gico (mini, perfecto aqu√≠ tras haber repasado los primeros eventos)
            {
                type: 'timeline',
                title: 'Ordena estos momentos del m√°s antiguo al m√°s reciente',
                description: 'Toca para reordenar... üìÖ',
                events: [
                    { text: 'ü¶Ä Cangrejo en la piscina', order: 0 },
                    { text: 'üíã Primer beso (PSV-Sevilla)', order: 1 },
                    { text: 'üå≤ San Nicol√°s del Puerto', order: 2 },
                    { text: 'üè∞ Primera vez en Granada', order: 3 },
                    { text: 'üé° Viaje a Londres', order: 4 }
                ]
            },

            // DESAF√çO 16: Concierto cancelado en Granada (input)
            {
                type: 'input',
                title: '¬øQu√© concierto √≠bamos a ver en Granada y nos cancelaron?',
                description: 'Vaya chasco... üé§',
                answer: 'rels'
            },

            // DESAF√çO 17: Primer aniversario - regalo (multiple)
            {
                type: 'multiple',
                title: '¬øQu√© te regal√© en nuestro primer aniversario?',
                description: 'Aquel 3 de octubre... üéÅ',
                options: [
                    'Una canci√≥n',
                    'Un viaje',
                    'Un concierto',
                    'Todo lo anterior'
                ],
                correct: 3
            },

            // DESAF√çO 18: Primer viaje internacional - Londres (input)
            {
                type: 'input',
                title: '¬øCu√°l fue nuestro primer viaje fuera de Espa√±a?',
                description: 'La primera aventura internacional... ‚úàÔ∏è',
                answer: 'londres'
            },

            // DESAF√çO 19: MINIJUEGO 4 - Memory ciudades (mini, tras hablar de viajes)
            {
                type: 'memory',
                title: 'Encuentra las parejas de ciudades',
                description: 'Empareja los lugares que hemos visitado juntos... üó∫Ô∏è',
                pairs: ['üé°', 'üçï', 'üè∞', 'üéª', 'üèñÔ∏è', '‚öΩ', 'üå≤', 'üé≠']
            },

            // DESAF√çO 20: Partidos Sevilla fuera de casa (input)
            {
                type: 'input',
                title: '¬øA cu√°ntos partidos del Sevilla hemos ido fuera de casa juntos?',
                description: 'Escribe el n√∫mero... ‚öΩ',
                answer: '7'
            },

            // DESAF√çO 21: Ciudades del norte (multiple)
            {
                type: 'multiple',
                title: '¬øCu√°l de estas ciudades del norte NO hemos visitado juntos?',
                description: 'Conociendo Espa√±a... üá™üá∏',
                options: [
                    'Oviedo',
                    'Santander',
                    'San Sebasti√°n',
                    'Bilbao'
                ],
                correct: 2
            },

            // DESAF√çO 22: MINIJUEGO 5 - Reaction game (mini, momento de energ√≠a)
            {
                type: 'reaction',
                title: '¬°Pon a prueba tus reflejos!',
                description: 'Espera a que aparezca el coraz√≥n y t√≥calo r√°pido... ‚ö°',
                timeout: 350
            },

            // DESAF√çO 23: Fuerteventura (input)
            {
                type: 'input',
                title: '¬øEn qu√© isla de Canarias estuvimos?',
                description: 'Sol, playa y relax... üèñÔ∏è',
                answer: 'fuerteventura'
            },

            // DESAF√çO 24: Completa la canci√≥n (input)
            {
                type: 'input',
                title: 'Completa la letra de "Con la luna llena"',
                description: '"Porque te quiero como el mar quiere a un pez que nada adentro, d√°ndole de respirar, protegi√©ndolo del _____"',
                answer: 'viento'
            },

            // DESAF√çO 25: Budapest y Viena (multiple)
            {
                type: 'multiple',
                title: '¬øQu√© dos ciudades visitamos en el mismo viaje?',
                description: 'Nuestro √∫ltimo gran viaje... üéªüè∞',
                options: [
                    'Budapest y Viena',
                    'Londres y Par√≠s',
                    'Mil√°n y Venecia',
                    'Praga y Berl√≠n'
                ],
                correct: 0
            },

            // DESAF√çO 26: MINIJUEGO 6 - Find Hearts (mini)
            {
                type: 'findHearts',
                title: 'Encuentra los 4 corazones rojos',
                description: 'Un poco m√°s f√°cil esta vez... ‚ù§Ô∏è',
                target: 4
            },

            // DESAF√çO 27: Mil√°n (multiple)
            {
                type: 'multiple',
                title: '¬øEn qu√© mes fuimos a Mil√°n?',
                description: 'Ciudad de la moda... üçï',
                options: [
                    'Febrero 2025',
                    'Enero 2025',
                    'Marzo 2025',
                    'Abril 2025'
                ],
                correct: 0
            },

            // DESAF√çO 28: Qu√© nos gusta hacer juntos (multiple)
            {
                type: 'multiple',
                title: '¬øQu√© nos gusta hacer juntos m√°s que nada?',
                description: 'Pensando en todos nuestros momentos... üí≠',
                options: [
                    'Ver al Sevilla',
                    'Viajar',
                    'Ir a conciertos',
                    'Todo, si estamos juntos'
                ],
                correct: 3
            },

            // DESAF√çO 29: MINIJUEGO 7 - Photo Match (mini)
            {
                type: 'photoMatch',
                title: 'Encuentra las parejas de nuestras fotos',
                description: 'Empareja las mitades correctas... üì∏',
                photos: [
                    'images/foto1.jpg',
                    'images/foto2.jpg',
                    'images/foto3.jpg',
                    'images/foto4.jpg',
                    'images/foto5.jpg'
                ]
            },

            // DESAF√çO 30: Hotel caja sorpresa (multiple)
            {
                type: 'multiple',
                title: '¬øD√≥nde nos toc√≥ el hotel en la caja sorpresa que me regalaste?',
                description: 'Aquella escapada... üéÅüè®',
                options: [
                    'Setenil de las Bodegas',
                    'La L√≠nea de la Concepci√≥n',
                    'Ronda',
                    'Algeciras'
                ],
                correct: 1
            },

            // DESAF√çO 31: Nombre del perro (input)
            {
                type: 'input',
                title: '¬øC√≥mo hemos dicho de llamar a nuestro futuro perro?',
                description: 'Nuestro peque√±o amigo... üêï',
                answer: 'ever'
            },

            // DESAF√çO 32: MINIJUEGO 8 - Slider amor (mini, pen√∫ltimo)
            {
                type: 'slider',
                title: '¬øCu√°nto me quieres?',
                description: 'Desliza hasta el nivel correcto... üíï',
                target: 100
            },

            // DESAF√çO 33: Pregunta especial final (multiple)
            {
                type: 'multiple',
                title: '¬øQu√© hace especial cada momento contigo?',
                description: 'La respuesta m√°s importante... üíù',
                options: [
                    'La complicidad',
                    'Las risas juntos',
                    'La paz que me das',
                    'Todo lo anterior'
                ],
                correct: 3
            },

            // PANTALLA FINAL
            {
                type: 'final',
                title: '¬°Lo has conseguido! üéâ',
                message: `T√∫ me regalaste Granada, y hoy quiero devolverte ese momento m√°gico.

Desde aquel dia que hice el cangrejo en la piscina, cada momento contigo ha sido especial. Empezando por aquella primera cita en el cine, pasando por aquel famoso "Control historico de En Nesyri", y terminar con lo que mas nos gusta, que es recorriendo el mundo y animando a nuestro Sevilla. Por eso, te quiero regalar algo que disfrutes "Con la luna llena".`,
                surprise: {
                    title: 'Esta noche...',
                    location: 'Cenaremos viendo la Alhambra iluminada üè∞',
                    detail: 'Restaurante Las Tomasas a las 21:00',
                    message: 'Porque despu√©s de completar este desaf√≠o, mereces el mejor premio: una noche inolvidable juntos üí´'
                }
            }
        ];

        function updateProgress() {
            const totalChallenges = 33; // Total de desaf√≠os (sin contar la pantalla final)
            const currentProgress = Math.min(currentChallenge, totalChallenges);
            const percentage = (currentProgress / totalChallenges) * 100;
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${currentProgress}/${totalChallenges}`;
        }

        function renderChallenge() {
            const challenge = challenges[currentChallenge];
            const card = document.getElementById('challengeCard');
            let html = '';

            if (challenge.type !== 'final') {
                html += `<div class="challenge-number">Desaf√≠o ${currentChallenge + 1}/33</div>`;
            }

            switch (challenge.type) {
                case 'multiple':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="options">
                            ${challenge.options.map((option, index) => 
                                `<button class="option-btn" onclick="checkMultiple(${index})">${option}</button>`
                            ).join('')}
                        </div>
                    `;
                    break;

                case 'input':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <input type="text" class="input-field" id="answerInput" placeholder="Escribe tu respuesta...">
                        <button class="submit-btn" onclick="checkInput()">Comprobar</button>
                    `;
                    break;

                case 'memory':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="memory-grid" id="memoryGrid"></div>
                    `;
                    setTimeout(() => initMemoryGame(challenge.pairs), 100);
                    break;

                case 'findHearts':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="hearts-container" id="heartsContainer"></div>
                        <div class="hearts-counter" id="heartsCounter">0/${challenge.target}</div>
                    `;
                    setTimeout(() => initFindHearts(challenge.target), 100);
                    break;

                case 'tapHearts':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div id="tapHeartsGame">
                            <div class="reaction-area" style="padding: 40px 20px;">
                                <div style="font-size: 3em; margin-bottom: 20px;">‚ö°</div>
                                <p style="font-size: 1.1em; margin-bottom: 25px;">Cuando pulses el bot√≥n, tendr√°s ${challenge.timeLimit / 1000} segundos para tocar todos los corazones.</p>
                                <button class="submit-btn" onclick="startTapHearts(${challenge.total}, ${challenge.timeLimit})">Comenzar</button>
                            </div>
                        </div>
                    `;
                    break;

                case 'slider':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="slider-container">
                            <div class="slider-value" id="sliderValue">50</div>
                            <input type="range" min="0" max="100" value="50" class="love-slider" id="loveSlider" 
                                   oninput="document.getElementById('sliderValue').textContent = this.value">
                        </div>
                        <button class="submit-btn" onclick="checkSlider(${challenge.target})">Confirmar</button>
                    `;
                    break;

                case 'reaction':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="reaction-area" id="reactionArea">
                            <p style="font-size: 1.2em; color: #666;">Prep√°rate...</p>
                        </div>
                    `;
                    setTimeout(() => initReactionGame(challenge.timeout), 100);
                    break;

                case 'puzzle':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="puzzle-pieces" id="puzzleGrid"></div>
                        <button class="submit-btn" onclick="checkPuzzle()">Verificar Orden</button>
                    `;
                    setTimeout(() => initPuzzle(challenge.numbers), 100);
                    break;

                case 'timeline':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="timeline-container" id="timelineContainer"></div>
                        <button class="submit-btn" onclick="checkTimeline()">Verificar Orden</button>
                    `;
                    setTimeout(() => initTimeline(challenge.events), 100);
                    break;

                case 'drawHeart':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="canvas-container">
                            <canvas id="heartCanvas" width="300" height="300"></canvas>
                            <p class="canvas-instruction">Punto actual: <span id="currentPoint">1</span>/${challenge.points}</p>
                        </div>
                    `;
                    setTimeout(() => initDrawHeart(challenge.points), 100);
                    break;

                case 'photoMatch':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div class="photo-grid" id="photoGrid"></div>
                    `;
                    setTimeout(() => initPhotoMatch(challenge.photos), 100);
                    break;

                case 'sequence':
                    html += `
                        <h2 class="challenge-title">${challenge.title}</h2>
                        <p class="challenge-description">${challenge.description}</p>
                        <div id="sequenceDisplay" style="text-align: center; font-size: 4em; min-height: 100px; margin: 30px 0;"></div>
                        <div class="hearts-container" id="sequenceButtons" style="display: none;"></div>
                    `;
                    setTimeout(() => initSequenceGame(challenge.length), 100);
                    break;

                case 'final':
                    createConfetti(); // Crear confetti al llegar a la pantalla final
                    html = `
                        <div class="final-screen">
                            <div class="celebration">üéâüíùüéä</div>
                            <h2>${challenge.title}</h2>
                            <div class="final-message">${challenge.message}</div>
                            
                            <div class="reveal-container">
                                <div class="alhambra-icon">üè∞</div>
                                <div class="dinner-details">
                                    <h3>${challenge.surprise.location}</h3>
                                    <p>${challenge.surprise.detail}</p>
                                    <p style="margin-top: 20px; font-size: 1.3em;">‚è∞ Esta noche nos espera algo especial</p>
                                </div>
                                <div class="final-message" style="margin-top: 30px;">
                                    ${challenge.surprise.message}
                                </div>
                            </div>
                            
                            <div class="celebration">‚ù§Ô∏èüíïüíñ</div>
                        </div>
                    `;
                    // M√°s confetti despu√©s de 2 segundos
                    setTimeout(() => createConfetti(), 2000);
                    break;
            }

            card.innerHTML = html;
            updateProgress();
            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            const backBtn = document.getElementById('backBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            // Mostrar bot√≥n "Atr√°s" si no estamos en el primer desaf√≠o
            if (currentChallenge > 0) {
                backBtn.style.display = 'block';
            } else {
                backBtn.style.display = 'none';
            }
            
            // Mostrar bot√≥n "Siguiente" solo si ya ha completado el siguiente desaf√≠o antes
            if (currentChallenge < maxChallengeReached && currentChallenge < challenges.length - 1) {
                nextBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'none';
            }
        }

        function goBack() {
            if (currentChallenge > 0) {
                currentChallenge--;
                renderChallenge();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function goNext() {
            if (currentChallenge < maxChallengeReached && currentChallenge < challenges.length - 1) {
                currentChallenge++;
                renderChallenge();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function checkMultiple(selected) {
            const challenge = challenges[currentChallenge];
            const buttons = document.querySelectorAll('.option-btn');
            
            // Prevenir m√∫ltiples clics
            buttons.forEach(btn => btn.disabled = true);
            
            if (selected === challenge.correct) {
                buttons[selected].classList.add('correct');
                ErrorHandler.showToast('¬°Correcto! üéâ', 'success');
                setTimeout(() => nextChallenge(), 1000);
            } else {
                buttons[selected].classList.add('incorrect');
                ErrorHandler.showToast('¬°Casi! Int√©ntalo de nuevo', 'error');
                setTimeout(() => {
                    buttons[selected].classList.remove('incorrect');
                    buttons.forEach(btn => btn.disabled = false);
                }, 500);
            }
        }

        function checkInput() {
            const inputElement = document.getElementById('answerInput');
            const input = inputElement.value.toLowerCase().trim();
            const challenge = challenges[currentChallenge];
            
            // Validar que el input no est√© vac√≠o
            if (!ErrorHandler.validateInput(input)) {
                inputElement.style.animation = 'shake 0.5s ease';
                setTimeout(() => inputElement.style.animation = 'none', 500);
                return;
            }
            
            // Array de respuestas aceptables para ciertos desaf√≠os
            let isCorrect = false;
            
            // Desaf√≠o 1 (aniversario) - aceptar m√∫ltiples variantes
            if (challenge.title && challenge.title.includes('aniversario')) {
                const validAnswers = ['3 de octubre', '3 octubre', '3-octubre', '3/octubre', 'octubre 3', 'tres de octubre'];
                isCorrect = validAnswers.some(answer => input.includes(answer));
            }
            // Desaf√≠o 8 (Pablo Albor√°n) - aceptar con y sin tilde
            else if (challenge.title && challenge.title.includes('Cazorla')) {
                isCorrect = input.includes('pablo alboran') || input.includes('pablo albor√°n') || 
                           input.includes('alboran') || input.includes('albor√°n');
            }
            // Desaf√≠o 13 (apodos) - aceptar m√∫ltiples variantes
            else if (challenge.title && challenge.title.includes('cari√±osamente')) {
                const validAnswers = ['gordi', 'gordito', 'gordita', 'amor', 'amore', 'mi vida', 'vida'];
                isCorrect = validAnswers.some(answer => input.includes(answer));
            } 
            // Desaf√≠o 12 (conciertos cancelados) - aceptar Rels B y variantes
            else if (challenge.description && challenge.description.includes('cancelaron')) {
                isCorrect = input.includes('rels');
            }
            // Desaf√≠o 28 (Montana) - aceptar Montana, EEUU, Estados Unidos
            else if (challenge.title && challenge.title.includes('primer verano')) {
                isCorrect = input.includes('montana') || input.includes('eeuu') || 
                           input.includes('estados unidos') || input.includes('usa');
            }
            // Otros desaf√≠os
            else {
                isCorrect = input.includes(challenge.answer.toLowerCase());
            }
            
            if (isCorrect) {
                inputElement.style.borderColor = '#4CAF50';
                inputElement.style.background = 'linear-gradient(135deg, #A8E6CF, #E8F5E9)';
                inputElement.disabled = true;
                ErrorHandler.showToast('¬°Correcto! üéâ', 'success');
                setTimeout(() => nextChallenge(), 1000);
            } else {
                inputElement.style.borderColor = '#F44336';
                inputElement.style.animation = 'shake 0.5s ease';
                ErrorHandler.showToast('¬°Casi! Int√©ntalo de nuevo', 'error');
                setTimeout(() => {
                    inputElement.style.borderColor = '#9DE5DD';
                    inputElement.style.animation = 'none';
                    inputElement.value = '';
                    inputElement.focus();
                }, 500);
            }
        }

        function initMemoryGame(pairs) {
            memoryFlipped = [];
            memoryMatched = [];
            const allSymbols = [...pairs, ...pairs];
            memoryCards = allSymbols.sort(() => Math.random() - 0.5);
            
            const grid = document.getElementById('memoryGrid');
            grid.innerHTML = memoryCards.map((symbol, i) => 
                `<div class="memory-card" onclick="flipCard(${i})" data-symbol="${symbol}" data-index="${i}">
                    <span style="display: none;">${symbol}</span>
                </div>`
            ).join('');
        }

        function flipCard(index) {
            if (memoryFlipped.length >= 2 || memoryMatched.includes(index) || memoryFlipped.includes(index)) return;
            
            const cards = document.querySelectorAll('.memory-card');
            const card = cards[index];
            card.classList.add('flipped');
            card.querySelector('span').style.display = 'block';
            memoryFlipped.push(index);

            if (memoryFlipped.length === 2) {
                const [first, second] = memoryFlipped;
                const firstSymbol = cards[first].dataset.symbol;
                const secondSymbol = cards[second].dataset.symbol;

                if (firstSymbol === secondSymbol) {
                    setTimeout(() => {
                        cards[first].classList.add('matched');
                        cards[second].classList.add('matched');
                        memoryMatched.push(first, second);
                        memoryFlipped = [];

                        if (memoryMatched.length === memoryCards.length) {
                            ErrorHandler.showToast('¬°Todas las parejas encontradas! üéâ', 'success');
                            setTimeout(() => nextChallenge(), 1000);
                        }
                    }, 500);
                } else {
                    setTimeout(() => {
                        cards[first].classList.remove('flipped');
                        cards[second].classList.remove('flipped');
                        cards[first].querySelector('span').style.display = 'none';
                        cards[second].querySelector('span').style.display = 'none';
                        memoryFlipped = [];
                    }, 1000);
                }
            }
        }

        function initFindHearts(target) {
            heartsFound = 0;
            const container = document.getElementById('heartsContainer');
            // Usar solo corazones que NO sean rojos en el array base
            const hearts = ['üíô', 'üíö', 'üíõ', 'üíú', 'üß°', 'üíù', 'üíñ', 'ü§ç'];
            const redHeartPositions = [];
            
            while (redHeartPositions.length < target) {
                const pos = Math.floor(Math.random() * 8);
                if (!redHeartPositions.includes(pos)) {
                    redHeartPositions.push(pos);
                }
            }

            container.innerHTML = hearts.map((heart, i) => {
                const isRed = redHeartPositions.includes(i);
                return `<div class="heart-item" onclick="clickHeart(this, ${isRed}, ${target})">${isRed ? '‚ù§Ô∏è' : heart}</div>`;
            }).join('');
        }

        function clickHeart(element, isCorrect, target) {
            if (element.classList.contains('found')) return;
            
            if (isCorrect) {
                element.classList.add('found');
                heartsFound++;
                document.getElementById('heartsCounter').textContent = `${heartsFound}/${target}`;
                
                if (heartsFound === target) {
                    setTimeout(() => nextChallenge(), 1000);
                }
            }
        }

        let tapHeartsTimer = null;
        let tapHeartsStartTime = null;

        function startTapHearts(total, timeLimit) {
            const gameContainer = document.getElementById('tapHeartsGame');
            gameContainer.innerHTML = `
                <div class="hearts-container" id="heartsContainer"></div>
                <div class="hearts-counter" id="heartsCounter">0/${total}</div>
                <div style="text-align: center; margin-top: 15px; font-size: 1.2em; font-weight: 600; color: var(--accent);" id="timeRemaining">Tiempo: ${timeLimit / 1000}s</div>
            `;
            
            heartsFound = 0;
            tapHeartsStartTime = Date.now();
            initTapHearts(total, timeLimit);
            
            // Iniciar contador de tiempo
            tapHeartsTimer = setInterval(() => {
                const elapsed = Date.now() - tapHeartsStartTime;
                const remaining = Math.max(0, timeLimit - elapsed);
                const seconds = (remaining / 1000).toFixed(2);
                document.getElementById('timeRemaining').textContent = `Tiempo: ${seconds}s`;
                
                if (remaining <= 0) {
                    clearInterval(tapHeartsTimer);
                    // Tiempo agotado - fall√≥
                    const gameContainer = document.getElementById('tapHeartsGame');
                    gameContainer.innerHTML = `
                        <div class="reaction-area" style="padding: 40px 20px;">
                            <div style="font-size: 3em; margin-bottom: 20px;">üòÖ</div>
                            <p style="font-size: 1.2em; font-weight: 600; color: var(--error); margin-bottom: 15px;">¬°Se acab√≥ el tiempo!</p>
                            <p style="margin-bottom: 25px;">Tocaste ${heartsFound}/${total} corazones</p>
                            <button class="submit-btn" onclick="startTapHearts(${total}, ${timeLimit})">Intentar de Nuevo</button>
                        </div>
                    `;
                    ErrorHandler.showToast('¬°Demasiado lento! Int√©ntalo de nuevo', 'error');
                }
            }, 50);
        }

        function initTapHearts(total, timeLimit) {
            const container = document.getElementById('heartsContainer');
            const hearts = ['‚ù§Ô∏è', 'üíï', 'üíñ', 'üíó', 'üíì', 'üíù', 'üíò', 'üíû', 'üíô', 'üíö', 'üíõ', 'üíú'];
            
            container.innerHTML = hearts.map((heart, i) => 
                `<div class="heart-item" onclick="tapHeart(this, ${total}, ${timeLimit})">${heart}</div>`
            ).join('');
        }

        function tapHeart(element, total, timeLimit) {
            if (element.classList.contains('found')) return;
            
            element.classList.add('found');
            element.style.opacity = '0.3';
            heartsFound++;
            document.getElementById('heartsCounter').textContent = `${heartsFound}/${total}`;
            
            if (heartsFound === total) {
                clearInterval(tapHeartsTimer);
                const elapsedTime = Date.now() - tapHeartsStartTime;
                const seconds = (elapsedTime / 1000).toFixed(2);
                
                const gameContainer = document.getElementById('tapHeartsGame');
                gameContainer.innerHTML = `
                    <div class="reaction-area" style="padding: 40px 20px;">
                        <div style="font-size: 3em; margin-bottom: 20px;">üéâ</div>
                        <p style="font-size: 1.2em; font-weight: 600; color: var(--success); margin-bottom: 15px;">¬°Lo lograste!</p>
                        <p style="margin-bottom: 25px;">Tu tiempo: ${seconds}s</p>
                    </div>
                `;
                ErrorHandler.showToast('¬°Perfecto! üéâ', 'success');
                setTimeout(() => nextChallenge(), 1500);
            }
        }

        function checkSlider(target) {
            const value = parseInt(document.getElementById('loveSlider').value);
            if (value === target) {
                ErrorHandler.showToast('¬°Exacto! üíï', 'success');
                nextChallenge();
            } else if (value < 50) {
                ErrorHandler.showToast('En serio tan poquito? :( ', 'error');
            } else if (value >= 50 && value <= 99) {
                ErrorHandler.showToast('Venga va un poquito mas mujer :)', 'info');
            } else if (value >= target - 5) {
                ErrorHandler.showToast('Venga ya... sabes que me quieres m√°s jejejeje üíï', 'info');
            } else if (value >= target - 15) {
                ErrorHandler.showToast('¬°Casi! Un poquito m√°s... üíï', 'info');
            } else {
                ErrorHandler.showToast('¬°M√°s amor! ‚ù§Ô∏è', 'info');
            }
        }

        function initReactionGame(timeout) {
            reactionTimeout = timeout; // Guardar el timeout actual
            const area = document.getElementById('reactionArea');
            area.innerHTML = `
                <div style="font-size: 2em; padding: 20px 0;">‚ö°</div>
                <p style="font-size: 1.1em; margin: 20px 0;">Cuando veas aparecer el coraz√≥n, t√≥calo lo m√°s r√°pido que puedas.</p>
                <p style="color: #666; margin-bottom: 25px;">Tienes que hacerlo en menos de ${timeout}ms para continuar.</p>
                <button class="submit-btn" onclick="startReactionGame()">¬°Estoy Lista!</button>
            `;
        }

        function startReactionGame() {
            const area = document.getElementById('reactionArea');
            area.innerHTML = `<p style="font-size: 1.3em; color: #666;">Prep√°rate...</p>`;
            
            const delay = Math.random() * 2000 + 1000; // Entre 1 y 3 segundos
            
            setTimeout(() => {
                reactionStartTime = Date.now();
                area.innerHTML = `
                    <div style="font-size: 5em; padding: 40px 0; cursor: pointer; animation: heartBounce 0.5s ease;" onclick="reactionClick()">‚ù§Ô∏è</div>
                    <p style="font-size: 1.3em; font-weight: 600;">¬°TOCA AHORA!</p>
                `;
            }, delay);
        }

        function reactionClick() {
            const reactionTime = Date.now() - reactionStartTime;
            const area = document.getElementById('reactionArea');
            
            if (reactionTime <= reactionTimeout) {
                // ¬°√âxito! Tiempo r√°pido
                area.innerHTML = `
                    <div style="font-size: 3em; padding: 30px 0;">üéØ</div>
                    <p style="font-size: 1.2em; font-weight: 600; color: var(--success);">¬°Tu tiempo: ${reactionTime}ms!</p>
                    <p style="margin-top: 15px; font-size: 1.1em;">¬°Reflejos incre√≠bles! ‚ö°</p>
                `;
                setTimeout(() => nextChallenge(), 2000);
            } else {
                // Demasiado lento, intentar de nuevo
                area.innerHTML = `
                    <div style="font-size: 3em; padding: 30px 0;">üòÖ</div>
                    <p style="font-size: 1.2em; font-weight: 600; color: var(--error);">Tu tiempo: ${reactionTime}ms</p>
                    <p style="margin: 20px 0;">Necesitas hacerlo en menos de ${reactionTimeout}ms</p>
                    <button class="submit-btn" onclick="startReactionGame()">Intentar de Nuevo</button>
                `;
                ErrorHandler.showToast('¬°Demasiado lento! Int√©ntalo de nuevo', 'error');
            }
        }

        function initPuzzle(numbers) {
            puzzleOrder = [...numbers];
            const grid = document.getElementById('puzzleGrid');
            grid.innerHTML = puzzleOrder.map((num, i) => 
                `<div class="puzzle-piece" onclick="swapPuzzle(${i})" data-index="${i}">${num}</div>`
            ).join('');
        }

        let selectedPuzzlePiece = null;

        function swapPuzzle(index) {
            if (selectedPuzzlePiece === null) {
                selectedPuzzlePiece = index;
                document.querySelectorAll('.puzzle-piece')[index].style.border = '3px solid ' + getComputedStyle(document.documentElement).getPropertyValue('--accent');
            } else {
                [puzzleOrder[selectedPuzzlePiece], puzzleOrder[index]] = [puzzleOrder[index], puzzleOrder[selectedPuzzlePiece]];
                initPuzzle(puzzleOrder);
                selectedPuzzlePiece = null;
            }
        }

        function checkPuzzle() {
            const isCorrect = puzzleOrder.every((num, i) => num === i + 1);
            if (isCorrect) {
                document.querySelectorAll('.puzzle-piece').forEach(piece => {
                    piece.classList.add('correct-position');
                });
                ErrorHandler.showToast('¬°Puzzle completado! üß©', 'success');
                setTimeout(() => nextChallenge(), 1000);
            } else {
                ErrorHandler.showToast('¬°Casi! Sigue intent√°ndolo üß©', 'error');
            }
        }

        function initTimeline(events) {
            const container = document.getElementById('timelineContainer');
            const shuffled = [...events].sort(() => Math.random() - 0.5);
            
            // Guardamos el orden correcto en cada elemento
            container.innerHTML = shuffled.map((event, i) => 
                `<div class="timeline-item" data-order="${event.order}" data-text="${event.text}">
                    ${event.text}
                </div>`
            ).join('');

            // A√±adir event listeners a cada item
            const items = container.querySelectorAll('.timeline-item');
            items.forEach(item => {
                item.addEventListener('click', function() {
                    selectTimelineItem(this);
                });
            });
        }

        let firstSelectedTimeline = null;

        function selectTimelineItem(clickedElement) {
            if (firstSelectedTimeline === null) {
                // Primer click - seleccionar
                firstSelectedTimeline = clickedElement;
                clickedElement.style.border = '3px solid ' + getComputedStyle(document.documentElement).getPropertyValue('--accent');
                clickedElement.style.transform = 'scale(1.02)';
            } else {
                if (firstSelectedTimeline === clickedElement) {
                    // Click en el mismo elemento - deseleccionar
                    clickedElement.style.border = '2px solid var(--primary-dark)';
                    clickedElement.style.transform = 'scale(1)';
                    firstSelectedTimeline = null;
                    return;
                }
                
                // Segundo click - intercambiar posiciones en el DOM
                const container = document.getElementById('timelineContainer');
                const allItems = Array.from(container.querySelectorAll('.timeline-item'));
                const firstIndex = allItems.indexOf(firstSelectedTimeline);
                const secondIndex = allItems.indexOf(clickedElement);
                
                // Guardar referencias
                const firstItem = firstSelectedTimeline;
                const secondItem = clickedElement;
                
                // Intercambiar en el DOM
                if (firstIndex < secondIndex) {
                    container.insertBefore(secondItem, firstItem);
                    container.insertBefore(firstItem, allItems[secondIndex].nextSibling);
                } else {
                    container.insertBefore(firstItem, secondItem);
                    container.insertBefore(secondItem, allItems[firstIndex].nextSibling);
                }
                
                // Resetear estilos de todos los items
                container.querySelectorAll('.timeline-item').forEach(item => {
                    item.style.border = '2px solid var(--primary-dark)';
                    item.style.transform = 'scale(1)';
                });
                
                firstSelectedTimeline = null;
            }
        }

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            if (this !== draggedElement) {
                const allItems = [...document.querySelectorAll('.timeline-item')];
                const draggedIndex = allItems.indexOf(draggedElement);
                const targetIndex = allItems.indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedElement, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedElement, this);
                }
            }
        }

        function handleDragEnd() {
            this.classList.remove('dragging');
        }

        function checkTimeline() {
            const items = document.querySelectorAll('.timeline-item');
            let isCorrect = true;
            
            items.forEach((item, index) => {
                if (parseInt(item.dataset.order) === index) {
                    item.classList.add('correct-order');
                } else {
                    isCorrect = false;
                }
            });

            if (isCorrect) {
                ErrorHandler.showToast('¬°Orden correcto! üìÖ', 'success');
                setTimeout(() => nextChallenge(), 1500);
            } else {
                ErrorHandler.showToast('¬°Casi! Int√©ntalo de nuevo üìÖ', 'error');
                setTimeout(() => {
                    items.forEach(item => item.classList.remove('correct-order'));
                }, 1000);
            }
        }

        function initDrawHeart(numPoints) {
            const canvas = document.getElementById('heartCanvas');
            const ctx = canvas.getContext('2d');
            currentHeartPoint = 0;
            heartPoints = [];

            // Generar puntos en forma de coraz√≥n
            const centerX = 150;
            const centerY = 150;
            const size = 80;

            for (let i = 0; i < numPoints; i++) {
                const t = (i / numPoints) * Math.PI * 2;
                const x = centerX + size * (16 * Math.pow(Math.sin(t), 3));
                const y = centerY - size * (13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t)) / 16;
                heartPoints.push({x, y, number: i + 1});
            }

            // Dibujar puntos
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            heartPoints.forEach(point => {
                ctx.beginPath();
                ctx.arc(point.x, point.y, 15, 0, Math.PI * 2);
                ctx.fillStyle = '#BFF8F1';
                ctx.fill();
                ctx.strokeStyle = '#9DE5DD';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.fillStyle = '#2C3E50';
                ctx.font = 'bold 12px Quicksand';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(point.number, point.x, point.y);
            });

            canvas.onclick = function(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                const x = (e.clientX - rect.left) * scaleX;
                const y = (e.clientY - rect.top) * scaleY;

                const nextPoint = heartPoints[currentHeartPoint];
                const distance = Math.sqrt(Math.pow(x - nextPoint.x, 2) + Math.pow(y - nextPoint.y, 2));

                if (distance < 20) {
                    ctx.beginPath();
                    ctx.arc(nextPoint.x, nextPoint.y, 15, 0, Math.PI * 2);
                    ctx.fillStyle = '#FFB6C1';
                    ctx.fill();
                    
                    if (currentHeartPoint > 0) {
                        const prevPoint = heartPoints[currentHeartPoint - 1];
                        ctx.beginPath();
                        ctx.moveTo(prevPoint.x, prevPoint.y);
                        ctx.lineTo(nextPoint.x, nextPoint.y);
                        ctx.strokeStyle = '#FFB6C1';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                    }

                    currentHeartPoint++;
                    document.getElementById('currentPoint').textContent = currentHeartPoint + 1;

                    if (currentHeartPoint === numPoints) {
                        // Conectar √∫ltimo con primero
                        const firstPoint = heartPoints[0];
                        ctx.beginPath();
                        ctx.moveTo(nextPoint.x, nextPoint.y);
                        ctx.lineTo(firstPoint.x, firstPoint.y);
                        ctx.strokeStyle = '#FFB6C1';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                        
                        setTimeout(() => nextChallenge(), 1000);
                    }
                }
            };
        }

        function initPhotoMatch(photos) {
            // NOTA: Las fotos deben estar en la misma carpeta que este HTML
            // Nombra tus fotos como: foto1.jpg, foto2.jpg, foto3.jpg
            
            photoMatches = [];
            selectedPhotos = [];
            
            photos.forEach((photo, index) => {
                photoMatches.push(
                    { id: index * 2, photoIndex: index, half: 'left' },
                    { id: index * 2 + 1, photoIndex: index, half: 'right' }
                );
            });
            
            photoMatches.sort(() => Math.random() - 0.5);
            
            const grid = document.getElementById('photoGrid');
            grid.innerHTML = photoMatches.map((match, i) => {
                const bgPosition = match.half === 'left' ? 'left center' : 'right center';
                return `<div class="photo-piece" onclick="selectPhoto(${i})" data-photo-index="${match.photoIndex}" data-half="${match.half}" style="background-image: url('${photos[match.photoIndex]}'); background-position: ${bgPosition};"></div>`;
            }).join('');

            // Verificar carga de im√°genes
            setTimeout(() => {
                const pieces = grid.querySelectorAll('.photo-piece');
                let hasErrors = false;
                pieces.forEach((piece) => {
                    const bgImage = piece.style.backgroundImage;
                    if (bgImage && bgImage !== 'none') {
                        const url = bgImage.slice(5, -2);
                        const img = new Image();
                        img.onerror = () => {
                            piece.style.backgroundImage = 'none';
                            piece.innerHTML = 'üñºÔ∏è';
                            piece.style.display = 'flex';
                            piece.style.alignItems = 'center';
                            piece.style.justifyContent = 'center';
                            piece.style.fontSize = '2em';
                            piece.style.background = 'linear-gradient(135deg, #FFE5E5, #FFB6B6)';
                            hasErrors = true;
                        };
                        img.src = url;
                    }
                });
                if (hasErrors) {
                    ErrorHandler.showToast('Algunas fotos no se pudieron cargar. Aseg√∫rate de que las im√°genes est√©n en la misma carpeta.', 'error');
                }
            }, 100);
        }

        function selectPhoto(index) {
            const pieces = document.querySelectorAll('.photo-piece');
            const piece = pieces[index];
            
            if (piece.classList.contains('matched')) return;
            
            if (selectedPhotos.length === 0) {
                piece.classList.add('selected');
                selectedPhotos.push(index);
            } else if (selectedPhotos.length === 1) {
                if (selectedPhotos[0] === index) return;
                
                const firstPiece = pieces[selectedPhotos[0]];
                const firstPhotoIndex = firstPiece.dataset.photoIndex;
                const firstHalf = firstPiece.dataset.half;
                const secondPhotoIndex = piece.dataset.photoIndex;
                const secondHalf = piece.dataset.half;
                
                if (firstPhotoIndex === secondPhotoIndex && firstHalf !== secondHalf) {
                    piece.classList.add('matched');
                    firstPiece.classList.add('matched');
                    firstPiece.classList.remove('selected');
                    
                    setTimeout(() => {
                        if (document.querySelectorAll('.photo-piece.matched').length === photoMatches.length) {
                            setTimeout(() => nextChallenge(), 1000);
                        }
                    }, 500);
                } else {
                    piece.classList.add('selected');
                    setTimeout(() => {
                        piece.classList.remove('selected');
                        firstPiece.classList.remove('selected');
                    }, 1000);
                }
                
                selectedPhotos = [];
            }
        }

        let sequencePattern = [];
        let userSequence = [];

        function initSequenceGame(length) {
            sequencePattern = [];
            userSequence = [];
            const emojis = ['‚ù§Ô∏è', 'üíï', 'üíñ', 'üíó', 'üíì'];
            
            // Generar secuencia aleatoria
            for (let i = 0; i < length; i++) {
                sequencePattern.push(emojis[Math.floor(Math.random() * emojis.length)]);
            }
            
            // Mostrar secuencia
            showSequence();
        }

        function showSequence() {
            const display = document.getElementById('sequenceDisplay');
            let index = 0;
            
            display.textContent = 'üëÄ Observa...';
            
            const interval = setInterval(() => {
                if (index < sequencePattern.length) {
                    display.textContent = sequencePattern[index];
                    index++;
                } else {
                    clearInterval(interval);
                    display.textContent = '¬°Ahora rep√≠tela!';
                    showSequenceButtons();
                }
            }, 800);
        }

        function showSequenceButtons() {
            const container = document.getElementById('sequenceButtons');
            const emojis = ['‚ù§Ô∏è', 'üíï', 'üíñ', 'üíó', 'üíì'];
            
            container.style.display = 'grid';
            container.innerHTML = emojis.map(emoji => 
                `<div class="heart-item" onclick="selectSequenceEmoji('${emoji}')" style="cursor: pointer;">${emoji}</div>`
            ).join('');
        }

        function selectSequenceEmoji(emoji) {
            userSequence.push(emoji);
            const display = document.getElementById('sequenceDisplay');
            display.textContent = userSequence.join(' ');
            
            // Verificar cada paso
            const currentIndex = userSequence.length - 1;
            if (userSequence[currentIndex] !== sequencePattern[currentIndex]) {
                display.textContent = '‚ùå Incorrecto';
                ErrorHandler.showToast('Int√©ntalo de nuevo', 'error');
                setTimeout(() => {
                    userSequence = [];
                    display.textContent = '¬°Intenta de nuevo!';
                }, 1500);
                return;
            }
            
            // Si complet√≥ toda la secuencia correctamente
            if (userSequence.length === sequencePattern.length) {
                display.textContent = '‚úÖ ¬°Perfecto!';
                ErrorHandler.showToast('¬°Secuencia correcta! üéâ', 'success');
                setTimeout(() => nextChallenge(), 1500);
            }
        }

        function nextChallenge() {
            currentChallenge++;
            
            // Actualizar el m√°ximo desaf√≠o alcanzado
            if (currentChallenge > maxChallengeReached) {
                maxChallengeReached = currentChallenge;
                // Guardar tambi√©n el m√°ximo alcanzado
                ErrorHandler.safeLocalStorage.set('maxChallengeReached', maxChallengeReached);
            }
            
            // Guardar progreso autom√°ticamente
            ErrorHandler.safeLocalStorage.set('loveGameProgress', currentChallenge);
            
            if (currentChallenge < challenges.length) {
                renderChallenge();
            }
        }

        // ========================================
        // INICIALIZACI√ìN Y PERSISTENCIA
        // ========================================
        
        // Limpiar progreso guardado al inicio (comentar esta l√≠nea si quieres mantener el progreso)
        ErrorHandler.safeLocalStorage.remove('loveGameProgress');
        ErrorHandler.safeLocalStorage.remove('maxChallengeReached');

        // Cargar progreso guardado
        window.addEventListener('load', () => {
            const savedProgress = ErrorHandler.safeLocalStorage.get('loveGameProgress', 0);
            const savedMax = ErrorHandler.safeLocalStorage.get('maxChallengeReached', 0);
            
            if (savedProgress > 0 && savedProgress < challenges.length - 1) {
                // Mostrar notificaci√≥n en lugar de confirm invasivo
                ErrorHandler.showToast(`Progreso guardado en desaf√≠o ${savedProgress + 1}. Continuando...`, 'info');
                currentChallenge = savedProgress;
                maxChallengeReached = savedMax;
            }
            renderChallenge();
        });

        // Guardar al salir de la p√°gina
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && currentChallenge < challenges.length) {
                ErrorHandler.safeLocalStorage.set('loveGameProgress', currentChallenge);
            }
        });

        // Prevenir cierre accidental
        window.addEventListener('beforeunload', (e) => {
            if (currentChallenge > 0 && currentChallenge < challenges.length - 1) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Initialize (comentado porque ahora lo hacemos en window.load)
        // renderChallenge();
    

    // ============================================
    // SISTEMA DE BLOQUEO CON RETOS PRINCIPALES + EXTRAS
    // ============================================
    const LockSystem = {
        PASSWORD: 'C4NGR3J0',
        UNLOCK_DATE: new Date('2026-02-14T15:33:00'),
        MAX_EXTRA_CHALLENGES: 3,
        
        // Mapeo aleatorio de retos a letras
        // C=0, 4=1, N=2, G=3, R=4, E=5, J=6, 0=7
        LETTER_MAPPING: [5, 2, 7, 1, 6, 0, 4, 3], // Orden aleatorio
        
        gameState: {
            completedMain: [],      // Retos principales completados
            completedExtra: [],     // Retos extra completados
            revealedLetters: [],    // Letras reveladas
            isUnlocked: false
        },

        init() {
            this.loadState();
            this.updateCountdown();
            setInterval(() => this.updateCountdown(), 1000);
            
            const input = document.getElementById('passwordInput');
            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.checkPassword();
                });
            }

            const modal = document.getElementById('challengesModal');
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) this.closeChallenges();
                });
            }
        },

        loadState() {
            const saved = localStorage.getItem('valentineGameState');
            if (saved) {
                try {
                    this.gameState = JSON.parse(saved);
                    this.updateUI();
                } catch (e) {
                    console.error('Error loading state:', e);
                }
            }
        },

        saveState() {
            localStorage.setItem('valentineGameState', JSON.stringify(this.gameState));
        },

        updateUI() {
            // Actualizar hints
            const hintContainer = document.getElementById('passwordHint');
            if (hintContainer) {
                const hints = hintContainer.querySelectorAll('span');
                hints.forEach((hint, index) => {
                    if (this.gameState.revealedLetters.includes(index)) {
                        hint.textContent = this.PASSWORD[index];
                        hint.classList.add('revealed');
                    } else {
                        hint.textContent = '_';
                        hint.classList.remove('revealed');
                    }
                });
            }

            // Actualizar progreso
            const progressInfo = document.getElementById('progressInfo');
            if (progressInfo) {
                progressInfo.textContent = 
                    `${this.gameState.revealedLetters.length} de ${this.PASSWORD.length} letras reveladas`;
            }

            // Actualizar info de extras
            const extraInfo = document.getElementById('extraInfo');
            if (extraInfo) {
                const extrasUsed = this.gameState.completedExtra.length;
                extraInfo.textContent = `${extrasUsed}/${this.MAX_EXTRA_CHALLENGES} retos extra usados`;
            }

            // Actualizar checkboxes y bloqueos
            const mainItems = document.querySelectorAll('.challenge-item[data-type="main"]');
            mainItems.forEach((item, index) => {
                const checkbox = item.querySelector('.challenge-checkbox');
                const isCompleted = this.gameState.completedMain.includes(index);
                const isExtraCompleted = this.gameState.completedExtra.includes(index);
                
                if (checkbox) {
                    checkbox.checked = isCompleted;
                    checkbox.disabled = isExtraCompleted;
                }
                
                if (isCompleted) {
                    item.classList.add('completed');
                    item.classList.remove('blocked');
                    // Bloquear el reto extra correspondiente
                    this.blockExtraChallenge(index);
                } else if (isExtraCompleted) {
                    item.classList.add('blocked');
                    item.classList.remove('completed');
                } else {
                    item.classList.remove('completed', 'blocked');
                }
            });

            const extraItems = document.querySelectorAll('.challenge-item[data-type="extra"]');
            extraItems.forEach((item, index) => {
                const checkbox = item.querySelector('.challenge-checkbox');
                const isCompleted = this.gameState.completedExtra.includes(index);
                const isMainCompleted = this.gameState.completedMain.includes(index);
                const extrasUsed = this.gameState.completedExtra.length;
                
                // Bloquear si: su main est√° completo, o si ya se usaron 3 extras y este no est√° completado
                const shouldBlock = isMainCompleted || (extrasUsed >= this.MAX_EXTRA_CHALLENGES && !isCompleted);
                
                if (checkbox) {
                    checkbox.checked = isCompleted;
                    checkbox.disabled = shouldBlock;
                }
                
                if (isCompleted) {
                    item.classList.add('completed');
                    item.classList.remove('blocked');
                } else if (shouldBlock) {
                    item.classList.add('blocked');
                    item.classList.remove('completed');
                } else {
                    item.classList.remove('completed', 'blocked');
                }
            });

            // Si est√° desbloqueado
            if (this.gameState.isUnlocked) {
                const lockScreen = document.getElementById('lockScreen');
                const gameContent = document.getElementById('gameContent');
                if (lockScreen) lockScreen.classList.add('unlocked');
                if (gameContent) gameContent.classList.remove('locked');
            }
        },

        blockExtraChallenge(index) {
            const extraItem = document.querySelector(`.challenge-item[data-type="extra"][data-challenge="${index}"]`);
            if (extraItem) {
                extraItem.classList.add('blocked');
                const checkbox = extraItem.querySelector('.challenge-checkbox');
                if (checkbox) checkbox.disabled = true;
            }
        },

        blockMainChallenge(index) {
            const mainItem = document.querySelector(`.challenge-item[data-type="main"][data-challenge="${index}"]`);
            if (mainItem) {
                mainItem.classList.add('blocked');
                const checkbox = mainItem.querySelector('.challenge-checkbox');
                if (checkbox) checkbox.disabled = true;
            }
        },

        toggleChallenge(index, type) {
            if (type === 'main') {
                if (this.gameState.completedMain.includes(index)) {
                    // Desmarcar main
                    this.gameState.completedMain = this.gameState.completedMain.filter(i => i !== index);
                    const letterPos = this.LETTER_MAPPING[index];
                    this.gameState.revealedLetters = this.gameState.revealedLetters.filter(i => i !== letterPos);
                    this.showToast('Reto principal desmarcado', 'info');
                } else {
                    // Marcar main
                    this.gameState.completedMain.push(index);
                    const letterPos = this.LETTER_MAPPING[index];
                    if (!this.gameState.revealedLetters.includes(letterPos)) {
                        this.gameState.revealedLetters.push(letterPos);
                    }
                    this.showToast('¬°Reto principal completado! +1 letra üéâ', 'success');
                }
            } else {
                // Extra
                const extrasUsed = this.gameState.completedExtra.length;
                
                if (this.gameState.completedExtra.includes(index)) {
                    // Desmarcar extra
                    this.gameState.completedExtra = this.gameState.completedExtra.filter(i => i !== index);
                    const letterPos = this.LETTER_MAPPING[index];
                    this.gameState.revealedLetters = this.gameState.revealedLetters.filter(i => i !== letterPos);
                    this.showToast('Reto extra desmarcado', 'info');
                } else {
                    // Marcar extra
                    if (extrasUsed >= this.MAX_EXTRA_CHALLENGES) {
                        this.showToast('Ya has usado los 3 retos extra m√°ximos', 'error');
                        return;
                    }
                    
                    this.gameState.completedExtra.push(index);
                    const letterPos = this.LETTER_MAPPING[index];
                    if (!this.gameState.revealedLetters.includes(letterPos)) {
                        this.gameState.revealedLetters.push(letterPos);
                    }
                    this.showToast('¬°Reto extra completado! +1 letra üéâ', 'success');
                    // Bloquear el reto main correspondiente
                    this.blockMainChallenge(index);
                }
            }
            
            this.saveState();
            this.updateUI();
        },

        checkPassword() {
            const input = document.getElementById('passwordInput');
            const messageDiv = document.getElementById('passwordMessage');
            
            if (!input || !messageDiv) return;
            
            if (input.value.toUpperCase() === this.PASSWORD) {
                this.gameState.isUnlocked = true;
                this.saveState();
                messageDiv.innerHTML = '<div class="success-message">üéâ ¬°Contrase√±a correcta! Desbloqueando...</div>';
                
                setTimeout(() => {
                    this.updateUI();
                    this.showToast('¬°Juego desbloqueado! üíù', 'success');
                }, 1000);
            } else {
                messageDiv.innerHTML = '<div class="error-message">‚ùå Contrase√±a incorrecta. ¬°Sigue completando retos!</div>';
                setTimeout(() => {
                    messageDiv.innerHTML = '';
                }, 3000);
            }
        },

        updateCountdown() {
            const timerEl = document.getElementById('countdownTimer');
            if (!timerEl) return;

            const now = new Date();
            const diff = this.UNLOCK_DATE - now;
            
            if (diff <= 0) {
                if (!this.gameState.isUnlocked) {
                    this.gameState.isUnlocked = true;
                    this.saveState();
                    this.updateUI();
                    this.showToast('¬°Tiempo cumplido! Juego desbloqueado üéâ', 'success');
                }
                timerEl.textContent = '¬°DESBLOQUEADO!';
                return;
            }
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            let countdownText = '';
            if (days > 0) countdownText += `${days}d `;
            countdownText += `${hours}h ${minutes}m ${seconds}s`;
            
            timerEl.textContent = countdownText;
        },

        openChallenges() {
            const modal = document.getElementById('challengesModal');
            if (modal) modal.classList.add('active');
        },

        closeChallenges() {
            const modal = document.getElementById('challengesModal');
            if (modal) modal.classList.remove('active');
        },

        showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || icons.info}</span>
                <span class="toast-message">${message}</span>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
    };

    // Inicializar
    window.addEventListener('DOMContentLoaded', () => {
        LockSystem.init();
    });
</script>
</div><!-- #gameContent -->
</body>
</html>